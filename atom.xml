<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Eugene Zhulenev]]></title>
  <link href="http://eugenezhulenev.com/atom.xml" rel="self"/>
  <link href="http://eugenezhulenev.com/"/>
  <updated>2015-10-08T11:31:59-04:00</updated>
  <id>http://eugenezhulenev.com/</id>
  <author>
    <name><![CDATA[Eugene Zhulenev]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Optimizing Spark Machine Learning for Small Data]]></title>
    <link href="http://eugenezhulenev.com/blog/2015/09/16/spark-ml-for-big-and-small-data/"/>
    <updated>2015-09-16T10:04:25-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2015/09/16/spark-ml-for-big-and-small-data</id>
    <content type="html"><![CDATA[<blockquote>
  <p><strong>Update 2015-10-08</strong>: Optimization “hack” described in this post still works, however we don’t use it in production anymore. 
With careful parallelism config, overhead introduced by distributed models is negligible.</p>
</blockquote>

<p>You’ve all probably already know how awesome is Spark for doing Machine Learning on Big Data. However I’m pretty sure
no one told you how bad (slow) it can be on Small Data. </p>

<p>As I mentioned in my <a href="http://eugenezhulenev.com/blog/2015/09/09/audience-modeling-with-spark-ml-pipelines">previous post</a>, we
extensively use Spark for doing machine learning and audience modeling. It turned out that in some cases, for example when
we are starting optimization for new client/campaign we simply don’t have enough positive examples to construct big enough dataset, so that
using Spark would make sense.</p>

<!-- more -->

<h3 id="spark-ml-from-10000-feet">Spark ML from 10000 feet</h3>

<p>Essentially every machine learning algorithm is a function minimization, where function value depends on some calculation using data in <code>RDD</code>.
For example logistic regression can calculate function value 1000 times before it will converge and find optimal parameters. It means that it will 
compute some <code>RDD</code> 1000 times. In case of <code>LogisticRegression</code> it’s doing <code>RDD.treeAggregate</code> which is supper efficient, but still it’s distributed 
computation.</p>

<p>Now imagine that all the data you have is 50000 rows, and you have for example 1000 partitions. It means that each partition has only 50 rows. And 
each <code>RDD.treeAggregate</code> on every iteration serializing closures, sending them to partitions and collecting result back. 
It’s <strong>HUGE OVERHEAD</strong> and huge load on a driver.</p>

<h3 id="throw-away-spark-and-use-pythonr">Throw Away Spark and use Python/R?</h3>

<p>It’s definitely an option, but we don’t want to build multiple systems for data of different size. Spark ML pipelines are awesome abstraction,
and we want to use it for all machine learning jobs. Also we want to use the same algorithm, so results would be consistent if dataset size
just crossed the boundary between small and big data.</p>

<h3 id="run-logisticregression-in-local-mode">Run LogisticRegression in ‘Local Mode’</h3>

<p>What if Spark could run the same machine learning algorithm, but instead of using <code>RDD</code> for storing input data, it would use <code>Arrays</code>?
It solves all the problems, you get consistent model, computed 10-20x faster because it doesn’t need distributed computations.</p>

<p>That’s exactly approach I used in <a href="https://github.com/collectivemedia/spark-ext">Spark Ext</a>, it’s called <a href="https://github.com/collectivemedia/spark-ext/blob/master/sparkext-mllib/src/main/scala/org/apache/spark/ml/classification/LocalLogisticRegression.scala">LocalLogisticRegression</a>.
It’s mostly copy-pasta from Spark <code>LogisticRegression</code>, but when input data frame has only single partition, it’s running
function optimization on one of the executors using <code>mapPartition</code> function, essentially using Spark as distributed executor service.</p>

<p>This approach is much better than collecting data to driver, because you are not limited by driver computational resources.</p>

<p>When <code>DataFrame</code> has more than 1 partition it just falls back to default distributed logistic regression.</p>

<p>Code for new <code>train</code> method looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">def</span> <span class="function">trainLocal</span>(
      <span class="key">instances</span>: <span class="predefined-type">Array</span>[(<span class="predefined-type">Double</span>, <span class="predefined-type">Vector</span>)]
    ): (LogisticRegressionModel, <span class="predefined-type">Array</span>[<span class="predefined-type">Double</span>]) = ...

def train(<span class="key">dataset</span>: DataFrame): LogisticRegressionModel = {

  <span class="keyword">if</span> (dataset.rdd.partitions.length == <span class="integer">1</span>) {
    log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Build LogisticRegression in local mode</span><span class="delimiter">&quot;</span></span>)

    val (model, objectiveHistory) = extractLabeledPoints(dataset).map {
      <span class="keyword">case</span> LabeledPoint(<span class="key">label</span>: <span class="predefined-type">Double</span>, <span class="key">features</span>: <span class="predefined-type">Vector</span>) =&gt; (label, features)
    }.mapPartitions { instances =&gt;
      Seq(trainLocal(instances.toArray)).toIterator
    }.first()

    val logRegSummary = <span class="keyword">new</span> BinaryLogisticRegressionTrainingSummary(
      model.transform(dataset),
      probabilityCol,
      labelCol,
      objectiveHistory)
    model.setSummary(logRegSummary)

  } <span class="keyword">else</span> {
    log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Fallback to distributed LogisticRegression</span><span class="delimiter">&quot;</span></span>)

    val that = classOf[LogisticRegression].getConstructor(classOf[<span class="predefined-type">String</span>]).newInstance(uid)
    val logisticRegression = copyValues(that)
    <span class="comment">// Scala Reflection magic to call protected train method</span>
    ...
    logisticRegression.train(dataset)
  }
}      
</pre></div>
</div>
 </figure></notextile></div>

<p>If input dataset size is less than 100000 rows, it will be placed inside single partition, and regression model will be trained in local mode.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
val <span class="key">base</span>: DataFrame = ...
val datasetPartitionSize = <span class="integer">100000</span>

<span class="comment">// Compute optimal partitions size based on base join</span>
val baseSize = base.count()
val numPartitions = (baseSize.toDouble / datasetPartitionSize).ceil.toInt
log.debug(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Response base size: </span><span class="inline"><span class="inline-delimiter">$</span>baseSize</span><span class="delimiter">&quot;</span></span>)
log.debug(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Repartition dataset using </span><span class="inline"><span class="inline-delimiter">$</span>numPartitions</span><span class="content"> partitions</span><span class="delimiter">&quot;</span></span>)
</pre></div>
</div>
 </figure></notextile></div>

<h2 id="results">Results</h2>

<p>With a little ingenuity (and copy paste) Spark became perfect tool for machine learning both on Small and Big Data. Most awesome thing is that this
new <code>LocalLogisticRegression</code> can be used as drop in replacement in Spark ML pipelines, producing exactly the same <code>LogisticRegressionModel</code> at the end.</p>

<p>It might be interesting idea to use this approach in Spark itself, because in this case it would be possible to do it
without doing so many code duplication. I’d love to see if anyone else had the same problem, and how solved it.</p>

<blockquote>
  <p>More cool Spark things in <a href="https://github.com/collectivemedia/spark-ext/">Github</a>.</p>
</blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Audience Modeling With Spark ML Pipelines]]></title>
    <link href="http://eugenezhulenev.com/blog/2015/09/09/audience-modeling-with-spark-ml-pipelines/"/>
    <updated>2015-09-09T09:04:25-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2015/09/09/audience-modeling-with-spark-ml-pipelines</id>
    <content type="html"><![CDATA[<p>At <a href="http://collective.com">Collective</a> we are heavily relying on machine learning and predictive modeling to 
run digital advertising business. All decisions about what ad to show at this particular time to this particular user
are made by machine learning models (some of them are real time, and some of them are offline).</p>

<p>We have a lot of projects that uses machine learning, common name for all of them can be <strong>Audience Modeling</strong>, as they
all are trying to predict audience conversion (<em>CTR, Viewability Rate, etc…</em>) based on browsing history, behavioral segments and other type of 
predictors.</p>

<p>For most of new development we use <a href="https://spark.apache.org">Spark</a> and <a href="https://spark.apache.org/mllib/">Spark MLLib</a>. It is a awesome project,
however we found that some nice tools/libraries that are widely used for example in R are missing in Spark. In order to add missing
features that we would really like to have in Spark, we created <a href="https://github.com/collectivemedia/spark-ext">Spark Ext</a> - Spark Extensions
Library. </p>

<blockquote>
  <p>Spark Ext on Github: <a href="https://github.com/collectivemedia/spark-ext">https://github.com/collectivemedia/spark-ext</a></p>
</blockquote>

<p>I’m going to show simple example of combining <a href="https://github.com/collectivemedia/spark-ext">Spark Ext</a> with Spark ML pipelines for predicting user conversions based geo and browsing history data.</p>

<blockquote>
  <p>Spark ML pipeline example: <a href="https://github.com/collectivemedia/spark-ext/blob/master/sparkext-example/src/main/scala/com/collective/sparkext/example/SparkMlExtExample.scala">SparkMlExtExample.scala</a></p>
</blockquote>

<!-- more -->

<h2 id="predictors-data">Predictors Data</h2>

<p>I’m using dataset with 2 classes, that will be used for solving classification problem (user converted or not). It’s created with 
<a href="https://github.com/collectivemedia/spark-ext/blob/master/sparkext-example/src/main/scala/com/collective/sparkext/example/DataGenerator.scala">dummy data generator</a>, 
so that these 2 classes can be easily separated. It’s pretty similar to real data that usually available in digital advertising.</p>

<h3 id="browsing-history-log">Browsing History Log</h3>

<p>History of web sites that were visited by user.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Cookie          | Site          | Impressions  
--------------- |-------------- | -------------
wKgQaV0lHZanDrp | live.com      | 24
wKgQaV0lHZanDrp | pinterest.com | 21
rfTZLbQDwbu5mXV | wikipedia.org | 14
rfTZLbQDwbu5mXV | live.com      | 1
rfTZLbQDwbu5mXV | amazon.com    | 1
r1CSY234HTYdvE3 | youtube.com   | 10
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="geo-location-log">Geo Location Log</h3>

<p>Latitude/Longitude impression history.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Cookie          | Lat     | Lng       | Impressions
--------------- |---------| --------- | ------------
wKgQaV0lHZanDrp | 34.8454 | 77.009742 | 13
wKgQaV0lHZanDrp | 31.8657 | 114.66142 | 1
rfTZLbQDwbu5mXV | 41.1428 | 74.039600 | 20
rfTZLbQDwbu5mXV | 36.6151 | 119.22396 | 4
r1CSY234HTYdvE3 | 42.6732 | 73.454185 | 4
r1CSY234HTYdvE3 | 35.6317 | 120.55839 | 5
20ep6ddsVckCmFy | 42.3448 | 70.730607 | 21
20ep6ddsVckCmFy | 29.8979 | 117.51683 | 1
</pre></div>
</div>
 </figure></notextile></div>

<h2 id="transforming-predictors-data">Transforming Predictors Data</h2>

<p>As you can see predictors data (sites and geo) is in <em>long</em> format, each <code>cookie</code> has multiple rows associated with it,
and it’s in general is not a good fit for machine learning.
We’d like <code>cookie</code> to be a primary key, and all other data should form <code>feature vector</code>.</p>

<h3 id="gather-transformer">Gather Transformer</h3>

<p>Inspired by R <code>tidyr</code> and <code>reshape2</code> packages. Convert <em>long</em> <code>DataFrame</code> with values
for each key into <em>wide</em> <code>DataFrame</code>, applying aggregation function if single
key has multiple values.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
val gather = <span class="keyword">new</span> Gather()
      .setPrimaryKeyCols(<span class="string"><span class="delimiter">&quot;</span><span class="content">cookie</span><span class="delimiter">&quot;</span></span>)
      .setKeyCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">site</span><span class="delimiter">&quot;</span></span>)
      .setValueCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">impressions</span><span class="delimiter">&quot;</span></span>)
      .setValueAgg(<span class="string"><span class="delimiter">&quot;</span><span class="content">sum</span><span class="delimiter">&quot;</span></span>)         <span class="comment">// sum impression by key</span>
      .setOutputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">sites</span><span class="delimiter">&quot;</span></span>)
val gatheredSites = gather.transform(siteLog)      
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Cookie           | Sites
-----------------|----------------------------------------------
wKgQaV0lHZanDrp  | [
                 |  { site: live.com, impressions: 24.0 }, 
                 |  { site: pinterest.com, impressions: 21.0 }
                 | ]
rfTZLbQDwbu5mXV  | [
                 |  { site: wikipedia.org, impressions: 14.0 }, 
                 |  { site: live.com, impressions: 1.0 },
                 |  { site: amazon.com, impressions: 1.0 }
                 | ]
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="google-s2-geometry-cell-id-transformer">Google S2 Geometry Cell Id Transformer</h3>

<p>The S2 Geometry Library is a spherical geometry library, very useful for manipulating regions on the sphere (commonly on Earth) 
and indexing geographic data. Basically it assigns unique cell id for each region on the earth. </p>

<blockquote>
  <p>Good article about S2 library: <a href="http://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/">Google’s S2, geometry on the sphere, cells and Hilbert curve</a></p>
</blockquote>

<p>For example you can combine S2 transformer with Gather to get from <code>lat</code>/<code>lon</code> to <code>K-V</code> pairs, where key will be <code>S2</code> cell id.
Depending on a level you can assign all people in Greater New York area (level = 4) into one cell, or you can index them block by block (level = 12).</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">// Transform lat/lon into S2 Cell Id</span>
val s2Transformer = <span class="keyword">new</span> S2CellTransformer()
  .setLevel(<span class="integer">5</span>)
  .setCellCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cell</span><span class="delimiter">&quot;</span></span>)

<span class="comment">// Gather S2 CellId log</span>
val gatherS2Cells = <span class="keyword">new</span> Gather()
  .setPrimaryKeyCols(<span class="string"><span class="delimiter">&quot;</span><span class="content">cookie</span><span class="delimiter">&quot;</span></span>)
  .setKeyCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cell</span><span class="delimiter">&quot;</span></span>)
  .setValueCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">impressions</span><span class="delimiter">&quot;</span></span>)
  .setOutputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cells</span><span class="delimiter">&quot;</span></span>)
  
val gatheredCells = gatherS2Cells.transform(s2Transformer.transform(geoDf))
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Cookie           | S2 Cells
-----------------|----------------------------------------------
wKgQaV0lHZanDrp  | [
                 |  { s2_cell: d5dgds, impressions: 5.0 }, 
                 |  { s2_cell: b8dsgd, impressions: 1.0 }
                 | ]
rfTZLbQDwbu5mXV  | [
                 |  { s2_cell: d5dgds, impressions: 12.0 }, 
                 |  { s2_cell: b8dsgd, impressions: 3.0 },
                 |  { s2_cell: g7aeg3, impressions: 5.0 }
                 | ]
</pre></div>
</div>
 </figure></notextile></div>

<h2 id="assembling-feature-vector">Assembling Feature Vector</h2>

<p><code>K-V</code> pairs from result of <code>Gather</code> are cool, and groups all the information about cookie into single row, however they can’t be used
as input for machine learning. To be able to train a model, predictors data needs to be represented as a vector of doubles. If all features are continuous and
numeric it’s easy, but if some of them are categorical or in <code>gathered</code> shape, it’s not trivial.</p>

<h3 id="gather-encoder">Gather Encoder</h3>

<p>Encodes categorical key-value pairs using dummy variables. </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">// Encode S2 Cell data</span>
val encodeS2Cells = <span class="keyword">new</span> GatherEncoder()
  .setInputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cells</span><span class="delimiter">&quot;</span></span>)
  .setOutputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cells_f</span><span class="delimiter">&quot;</span></span>)
  .setKeyCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cell</span><span class="delimiter">&quot;</span></span>)
  .setValueCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">impressions</span><span class="delimiter">&quot;</span></span>)
  .setCover(<span class="float">0.95</span>) <span class="comment">// dimensionality reduction</span>
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Cookie           | S2 Cells
-----------------|----------------------------------------------
wKgQaV0lHZanDrp  | [
                 |  { s2_cell: d5dgds, impressions: 5.0 }, 
                 |  { s2_cell: b8dsgd, impressions: 1.0 }
                 | ]
rfTZLbQDwbu5mXV  | [
                 |  { s2_cell: d5dgds, impressions: 12.0 }, 
                 |  { s2_cell: g7aeg3, impressions: 5.0 }
                 | ]
</pre></div>
</div>
 </figure></notextile></div>

<p>Transformed into</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Cookie           | S2 Cells Features
-----------------|------------------------
wKgQaV0lHZanDrp  | [ 5.0  ,  1.0 , 0   ]
rfTZLbQDwbu5mXV  | [ 12.0 ,  0   , 5.0 ]
</pre></div>
</div>
 </figure></notextile></div>

<p>Note that it’s 3 unique cell id values, that gives 3 columns in final feature vector.</p>

<p>Optionally apply dimensionality reduction using <code>top</code> transformation:</p>

<ul>
  <li>Top coverage, is selecting categorical values by computing the count of distinct users for each value,
sorting the values in descending order by the count of users, and choosing the top values from the resulting
list such that the sum of the distinct user counts over these values covers c percent of all users,
for example, selecting top sites covering 99% of users.</li>
</ul>

<h2 id="spark-ml-pipelines">Spark ML Pipelines</h2>

<p>Spark ML Pipeline - is new high level API for Spark MLLib. </p>

<blockquote>
  <p>A practical ML pipeline often involves a sequence of data pre-processing, feature extraction, model fitting, and validation stages. For example, classifying text documents might involve text segmentation and cleaning, extracting features, and training a classification model with cross-validation. <a href="https://databricks.com/blog/2015/01/07/ml-pipelines-a-new-high-level-api-for-mllib.html">Read More.</a> </p>
</blockquote>

<p>In Spark ML it’s possible to split ML pipeline in multiple independent stages, group them together in single pipeline and run it
with Cross Validation and Parameter Grid to find best set of parameters.</p>

<h3 id="put-it-all-together-with-spark-ml-pipelines">Put It All together with Spark ML Pipelines</h3>

<p>Gather encoder is a natural fit into Spark ML Pipeline API.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">// Encode site data</span>
val encodeSites = <span class="keyword">new</span> GatherEncoder()
  .setInputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">sites</span><span class="delimiter">&quot;</span></span>)
  .setOutputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">sites_f</span><span class="delimiter">&quot;</span></span>)
  .setKeyCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">site</span><span class="delimiter">&quot;</span></span>)
  .setValueCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">impressions</span><span class="delimiter">&quot;</span></span>)

<span class="comment">// Encode S2 Cell data</span>
val encodeS2Cells = <span class="keyword">new</span> GatherEncoder()
  .setInputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cells</span><span class="delimiter">&quot;</span></span>)
  .setOutputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cells_f</span><span class="delimiter">&quot;</span></span>)
  .setKeyCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cell</span><span class="delimiter">&quot;</span></span>)
  .setValueCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">impressions</span><span class="delimiter">&quot;</span></span>)
  .setCover(<span class="float">0.95</span>)

<span class="comment">// Assemble feature vectors together</span>
val assemble = <span class="keyword">new</span> VectorAssembler()
  .setInputCols(<span class="predefined-type">Array</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">sites_f</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">s2_cells_f</span><span class="delimiter">&quot;</span></span>))
  .setOutputCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">features</span><span class="delimiter">&quot;</span></span>)

<span class="comment">// Build logistic regression</span>
val lr = <span class="keyword">new</span> LogisticRegression()
  .setFeaturesCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">features</span><span class="delimiter">&quot;</span></span>)
  .setLabelCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">response</span><span class="delimiter">&quot;</span></span>)
  .setProbabilityCol(<span class="string"><span class="delimiter">&quot;</span><span class="content">probability</span><span class="delimiter">&quot;</span></span>)

<span class="comment">// Define pipeline with 4 stages</span>
val pipeline = <span class="keyword">new</span> Pipeline()
  .setStages(<span class="predefined-type">Array</span>(encodeSites, encodeS2Cells, assemble, lr))

val evaluator = <span class="keyword">new</span> BinaryClassificationEvaluator()
  .setLabelCol(Response.response)

val crossValidator = <span class="keyword">new</span> CrossValidator()
  .setEstimator(pipeline)
  .setEvaluator(evaluator)

val paramGrid = <span class="keyword">new</span> ParamGridBuilder()
  .addGrid(lr.elasticNetParam, <span class="predefined-type">Array</span>(<span class="float">0.1</span>, <span class="float">0.5</span>))
  .build()

crossValidator.setEstimatorParamMaps(paramGrid)
crossValidator.setNumFolds(<span class="integer">2</span>)

println(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Train model on train set</span><span class="delimiter">&quot;</span></span>)
val cvModel = crossValidator.fit(trainSet)
</pre></div>
</div>
 </figure></notextile></div>

<h2 id="conclusion">Conclusion</h2>

<p>New Spark ML API makes machine learning much more easier. <a href="https://github.com/collectivemedia/spark-ext">Spark Ext</a> is good example of how is it possible to 
create custom transformers/estimators that later can be used as a part of bigger pipeline, and can be easily shared/reused by multiple projects.</p>

<blockquote>
  <p>Full code for example application is available on <a href="https://github.com/collectivemedia/spark-ext/blob/master/sparkext-example/src/main/scala/com/collective/sparkext/example/SparkMlExtExample.scala">Github</a>.</p>
</blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Interactive Audience Analytics With Spark and HyperLogLog]]></title>
    <link href="http://eugenezhulenev.com/blog/2015/07/15/interactive-audience-analytics-with-spark-and-hyperloglog/"/>
    <updated>2015-07-15T22:07:44-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2015/07/15/interactive-audience-analytics-with-spark-and-hyperloglog</id>
    <content type="html"><![CDATA[<p>At <a href="http://collective.com">Collective</a> we are working not only on cool things like 
<a href="http://eugenezhulenev.com/blog/2015/06/10/2015-06-10-feature-engineering-at-scale">Machine Learning and Predictive Modeling</a>, 
but also on reporting that can be tedious and boring. However at our scale even simple reporting 
application can become challenging engineering problem. This post is based on talk that 
I gave at <a href="http://www.meetup.com/ny-scala/events/223751768/">NY-Scala Meetup</a>. Slides are available <a href="http://eugenezhulenev.com/talks/interactive-audience-analytics/">here</a>.</p>

<blockquote>
  <p>Example application is available on github: <a href="https://github.com/collectivemedia/spark-hyperloglog">https://github.com/collectivemedia/spark-hyperloglog</a></p>
</blockquote>

<!-- more -->

<h2 id="impression-log">Impression Log</h2>

<p>We are building reporting application that is based on impression log. It’s not exactly the way how we get data from out partners,
it’s pre-aggregated by Ad, Site, Cookie. And even in this pre-aggregated format it takes hundreds of gigabytes per day on HDFS.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Ad            | Site          | Cookie          | Impressions | Clicks | Segments                       
------------- |-------------- | --------------- | ----------- | ------ | -------------------------------
bmw_X5        | forbes.com    | 13e835610ff0d95 | 10          | 1      | [a.m, b.rk, c.rh, d.sn, ...]   
mercedes_2015 | forbes.com    | 13e8360c8e1233d | 5           | 0      | [a.f, b.rk, c.hs, d.mr, ...]   
nokia         | gizmodo.com   | 13e3c97d526839c | 8           | 0      | [a.m, b.tk, c.hs, d.sn, ...]   
apple_music   | reddit.com    | 1357a253f00c0ac | 3           | 1      | [a.m, b.rk, d.sn, e.gh, ...]   
nokia         | cnn.com       | 13b23555294aced | 2           | 1      | [a.f, b.tk, c.rh, d.sn, ...]   
apple_music   | facebook.com  | 13e8333d16d723d | 9           | 1      | [a.m, d.sn, g.gh, s.hr, ...]   
</pre></div>
</div>
 </figure></notextile></div>

<p>Each cookie id has assigned segments which are just 4-6 letters code, that represents some information about cookie, that we
get from 3rd party data providers such as <a href="http://www.bluekai.com">Blukai</a>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
- a.m  : Male
- a.f  : Female
- b.tk : $75k-$100k annual income
- b.rk : $100k-$150k annual income
- c.hs : High School
- c.rh : College
- d.sn : Single
- d.mr : Married
</pre></div>
</div>
 </figure></notextile></div>

<p>For example if cookie has assigned <code>a.m</code> segment, it means that we think (actually data provider thinks) that this cookie belongs to male.
The same thing for annual income level. </p>

<p>We don’t have precise information, to whom exactly particular cookie belongs, and what is real
annual income level, this segments are essentially probabilistic, but we can get very interesting insights from this data.</p>

<h3 id="what-we-can-do-with-this-data">What we can do with this data</h3>

<p>Using this impression log we can answer some interesting questions</p>

<ul>
  <li>We can calculate a given group’s prevalence in a campaign’s audience, eg. what role do <strong>males</strong> play in the optimized audience for a <strong>Goodyear Tires</strong> campaign?</li>
  <li>What is <strong>male/female</strong> ratio for people who have seen <strong>bmw_X5</strong> ad on <strong>forbes.com</strong></li>
  <li>Income distribution for people who have seen Apple Music ad</li>
  <li>Nokia click distribution across different education levels  </li>
</ul>

<p>Using this basic questions we can create so called “Audience Profile”, that describes what type of audience is prevailing in optimized campaign or partner web site.</p>

<p><img class="center" src="http://eugenezhulenev.com/talks/interactive-audience-analytics/affinity.png" /></p>

<p>Blue bar means that this particular segment tend to view ad/visit web site more than on average, and red bar mean less. For example for <strong>Goodyear Tires</strong> we expect to see
more <strong>male</strong> audience than <strong>female</strong>.</p>

<h2 id="solving-problem-with-sql">Solving problem with SQL</h2>

<p>SQL looks like an easy choice for this problem, however as I already mentioned we have hundreds of gigabytes of data every day, and we
need to get numbers based on 1 year history in seconds. Hive/Impala simply can’t solve this problem.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="class">select</span> <span class="predefined">count</span>(<span class="keyword">distinct</span> cookie_id) <span class="keyword">from</span> impressions
    <span class="keyword">where</span> site = <span class="string"><span class="delimiter">'</span><span class="content">forbes.com</span><span class="delimiter">'</span></span>
    <span class="keyword">and</span> ad = <span class="string"><span class="delimiter">'</span><span class="content">bmw_X5</span><span class="delimiter">'</span></span>
    <span class="keyword">and</span> segment contains <span class="string"><span class="delimiter">'</span><span class="content">a.m</span><span class="delimiter">'</span></span>
</pre></div>
</div>
 </figure></notextile></div>

<p>Unfortunately we have almost infinite combinations of filters that users can define, so it’s not feasible to pre-generate all possible reports.
Users can use any arbitrary ad, site, campaign, order filter combinations, and may want to know audience intersection with any segment.</p>

<h2 id="audience-cardinality-approximation-with-hyperloglog">Audience cardinality approximation with HyperLogLog</h2>

<p>We came up with different solution, instead of providing precise results for every query, we are providing approximated number, but with
very high precision. Usually error is around 2% which for this particular application is really good. We don’t need to know exact number of male/female
cookies in audience. To be able to say what audience is prevailing, approximated numbers are more than enough.</p>

<p>We use <a href="https://en.wikipedia.org/wiki/HyperLogLog">HyperLogLog</a>, which is algorithm for the count-distinct problem, 
approximating the number of distinct elements (cardinality). It uses finite space and has configurable precision. 
It able to estimate cardinalities of &gt;10^9 with a typical accuracy of 2%, using 1.5kB of memory.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
trait HyperLogLog {
    <span class="keyword">def</span> <span class="function">add</span>(<span class="key">cookieId</span>: <span class="predefined-type">String</span>): Unit
    <span class="comment">//   |A|</span>
    <span class="keyword">def</span> <span class="function">cardinality</span>(): <span class="predefined-type">Long</span>
    <span class="comment">//   |A ∪ B|</span>
    <span class="keyword">def</span> <span class="function">merge</span>(<span class="key">other</span>: HyperLogLog): HyperLogLog
    <span class="comment">//   |A ∩ B| = |A| + |B| - |A ∪ B|,</span>
    <span class="keyword">def</span> <span class="function">intersect</span>(<span class="key">other</span>: HyperLogLog): <span class="predefined-type">Long</span>
}
</pre></div>
</div>
 </figure></notextile></div>

<p>Here is roughly API that is provided by <code>HyperLogLog</code>. You can add new cookieId to it, get cardinality estimation of unique cookies that were 
already added to it, merge it with another <code>HyperLogLog</code>, and finally get intersection. It’s important to notice that
after <code>intersect</code> operation <code>HyperLogLog</code> object is lost, and you have only approximated intersection cardinality. 
So usually <code>HyperLogLog</code> intersection is the last step in computation.</p>

<p>I suggest you to watch awesome talk by <a href="https://twitter.com/avibryant">Avi Bryant</a> where he discusses not only HyperLogLog but lot’s of other
approximation data structures that can be useful for big-data analytics: <a href="http://www.infoq.com/presentations/abstract-algebra-analytics">http://www.infoq.com/presentations/abstract-algebra-analytics</a>.</p>

<h2 id="from-cookies-to-hyperloglog">From cookies to HyperLogLog</h2>

<p>We split out original impression log into two tables. </p>

<p>For ad impressions table we remove segment information and aggregate cookies, impressions and clicks by Ad and Site. <code>HyperLogLog</code> can 
be used in aggregation function exactly the same was as <code>sum</code> operation. Zero is empty <code>HyperLogLog</code>, and plus operation is <code>merge</code> (btw it’s exactly
properties required by <code>Monoid</code>)</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Ad            | Site          | Cookies HLL        | Impressions | Clicks 
------------- | ------------- | ------------------ | ----------- | ------ 
bmw_X5        | forbes.com    | HyperLogLog@23sdg4 | 5468        | 35     
bmw_X5        | cnn.com       | HyperLogLog@84jdg4 | 8943        | 29     
</pre></div>
</div>
 </figure></notextile></div>

<p>For segments table we remove ad and site information, and aggregate data by segment.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Segment       | Cookies HLL        | Impressions | Clicks
------------- | ------------------ | ----------- | ------
Male          | HyperLogLog@85sdg4 | 235468      | 335   
$100k-$150k   | HyperLogLog@35jdg4 | 569473      | 194   
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="percent-of-college-and-high-school-education-in-bmw-campaign">Percent of college and high school education in BMW campaign</h3>

<p>If you imaging that we can load these tables into <code>Seq</code>, then audience intersection becomes really straightforward task, that can
be solved in couple line of functional scala operations.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">Audience</span>(<span class="key">ad</span>: <span class="predefined-type">String</span>, <span class="key">site</span>: <span class="predefined-type">String</span>, <span class="key">hll</span>: HyperLogLog, <span class="key">imp</span>: <span class="predefined-type">Long</span>, <span class="key">clk</span>: <span class="predefined-type">Long</span>)

<span class="keyword">case</span> <span class="type">class</span> <span class="class">Segment</span>(<span class="key">name</span>: <span class="predefined-type">String</span>, <span class="key">hll</span>: HyperLogLog, <span class="key">imp</span>: <span class="predefined-type">Long</span>, <span class="key">clk</span>: <span class="predefined-type">Long</span>)

val <span class="key">adImpressions</span>: Seq[Audience] = ...
val <span class="key">segmentImpressions</span>: Seq[<span class="predefined-type">Segment</span>] = ...

val <span class="key">bmwCookies</span>: HyperLogLog = adImpressions
    .filter(_.ad = <span class="string"><span class="delimiter">&quot;</span><span class="content">bmw_X5</span><span class="delimiter">&quot;</span></span>)
    .map(_.hll).reduce(_ merge _)

val <span class="key">educatedCookies</span>: HyperLogLog = segmentImpressions
    .filter(_.segment <span class="keyword">in</span> Seq(<span class="string"><span class="delimiter">&quot;</span><span class="content">College</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">High School</span><span class="delimiter">&quot;</span></span>))
    .map(_.hll).reduce( _ merge _)

val p = (bmwCookies intersect educatedCookies) / bmwCookies.count()
</pre></div>
</div>
 </figure></notextile></div>

<h2 id="spark-dataframes-with-hyperloglog">Spark DataFrames with HyperLogLog</h2>

<p>Obviously we can’t load all the data into scala <code>Seq</code> on single machine, because it’s huge, even after removing cookie level data
and transforming it into <code>HyperLogLog</code> objects, it’s around 1-2 gigabytes of data for single day.</p>

<p>So we have to use some distributed data processing framework to solve this problem, and we chose Spark.</p>

<h3 id="what-is-spark-dataframe">What is Spark DataFrame</h3>

<ul>
  <li>Inspired by R data.frame and Python/Pandas DataFrame</li>
  <li>Distributed collection of rows organized into named columns</li>
  <li>Used to be SchemaRDD in Spark &lt; 1.3.0</li>
</ul>

<h3 id="high-level-dataframe-operations">High-Level DataFrame Operations</h3>

<ul>
  <li>Selecting required columns</li>
  <li>Filtering</li>
  <li>Joining different data sets</li>
  <li>Aggregation (count, sum, average, etc)</li>
</ul>

<p>You can start from <a href="https://spark.apache.org/docs/1.3.0/sql-programming-guide.html">Spark DataFrame guide</a> or <a href="https://databricks.com/blog/2015/02/17/introducing-dataframes-in-spark-for-large-scale-data-science.html">DataBricks blog post</a>.</p>

<h3 id="ad-impressions-and-segments-in-dataframes">Ad impressions and segments in DataFrames</h3>

<p>We store all out data on HDFS using Parquet data format, and that’s how it looks after it’s loaded into Spark DataFrame.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
val <span class="key">adImpressions</span>: DataFrame = sqlContext.parquetFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/aa/audience</span><span class="delimiter">&quot;</span></span>)

adImpressions.printSchema()
<span class="comment">// root</span>
<span class="comment">//   | -- ad: string (nullable = true)</span>
<span class="comment">//   | -- site: string (nullable = true)</span>
<span class="comment">//   | -- hll: binary (nullable = true)</span>
<span class="comment">//   | -- impressions: long (nullable = true)</span>
<span class="comment">//   | -- clicks: long (nullable = true)</span>

val <span class="key">segmentImpressions</span>: DataFrame = sqlContext.parquetFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/aa/segments</span><span class="delimiter">&quot;</span></span>)

segmentImpressions.printSchema()
<span class="comment">// root</span>
<span class="comment">//   | -- segment: string (nullable = true)</span>
<span class="comment">//   | -- hll: binary (nullable = true)</span>
<span class="comment">//   | -- impressions: long (nullable = true)</span>
<span class="comment">//   | -- clicks: long (nullable = true)</span>
</pre></div>
</div>
 </figure></notextile></div>

<p><code>HyperLogLog</code> is essentially huge <code>Array[Byte]</code> with some clever hashing and math, so it’s straightforward to store it on HDFS in serialized form.</p>

<h2 id="working-with-spark-dataframe">Working with Spark DataFrame</h2>

<p>We want to know answer for the same question: “Percent of college and high school education in BMW campaign”.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">import</span> <span class="include">org.apache.spark.sql.functions._</span>
<span class="keyword">import</span> <span class="include">org.apache.spark.sql.HLLFunctions._</span>

val <span class="key">bmwCookies</span>: HyperLogLog = adImpressions
    .filter(col(<span class="string"><span class="delimiter">&quot;</span><span class="content">ad</span><span class="delimiter">&quot;</span></span>) === <span class="string"><span class="delimiter">&quot;</span><span class="content">bmw_X5</span><span class="delimiter">&quot;</span></span>)
    .select(mergeHll(col(<span class="string"><span class="delimiter">&quot;</span><span class="content">hll</span><span class="delimiter">&quot;</span></span>)).first() <span class="comment">// -- sum(clicks)</span>

val <span class="key">educatedCookies</span>: HyperLogLog = hllSegments
    .filter(col(<span class="string"><span class="delimiter">&quot;</span><span class="content">segment</span><span class="delimiter">&quot;</span></span>) <span class="keyword">in</span> Seq(<span class="string"><span class="delimiter">&quot;</span><span class="content">College</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">High School</span><span class="delimiter">&quot;</span></span>))
    .select(mergeHll(col(<span class="string"><span class="delimiter">&quot;</span><span class="content">hll</span><span class="delimiter">&quot;</span></span>)).first()

val p = (bmwCookies intersect educatedCookies) / bmwCookies.count()
</pre></div>
</div>
 </figure></notextile></div>

<p>It looks pretty familiar, not too far from example based on scala <code>Seq</code>. Only one unusual operation, that you might notice if you have some
experience with Spark is <code>mergeHLL</code>. It’s not available in Spark by default, it’s custom <code>PartialAggregate</code> function that can compute aggregates
for serialized <code>HyperLogLog</code> objects.</p>

<h3 id="writing-your-own-spark-aggregation-function">Writing your own Spark aggregation function</h3>

<p>To write you own aggregation function you need to define function that will be applied to each row in <code>RDD</code> partition, in this example
it’s called <code>MergeHLLPartition</code>. Then you need to define function that will take results from different partitions and merge them together, for <code>HyperLogLog</code>
it’s called <code>MergeHLLMerge</code>. And finally you need to tell Spark how you want it to split your computation across <code>RDD</code> (DataFrame is backed by <code>RDD[Row]</code>) </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">MergeHLLPartition</span>(<span class="key">child</span>: <span class="predefined-type">Expression</span>)
  <span class="directive">extends</span> AggregateExpression with trees.UnaryNode[<span class="predefined-type">Expression</span>] { ... }

<span class="keyword">case</span> <span class="type">class</span> <span class="class">MergeHLLMerge</span>(<span class="key">child</span>: <span class="predefined-type">Expression</span>)
  <span class="directive">extends</span> AggregateExpression with trees.UnaryNode[<span class="predefined-type">Expression</span>] { ... }

<span class="keyword">case</span> <span class="type">class</span> <span class="class">MergeHLL</span>(<span class="key">child</span>: <span class="predefined-type">Expression</span>)
  <span class="directive">extends</span> PartialAggregate with trees.UnaryNode[<span class="predefined-type">Expression</span>] {

  override <span class="keyword">def</span> <span class="key">asPartial</span>: SplitEvaluation = {
    val partial = Alias(MergeHLLPartition(child), <span class="string"><span class="delimiter">&quot;</span><span class="content">PartialMergeHLL</span><span class="delimiter">&quot;</span></span>)()

    SplitEvaluation(
      MergeHLLMerge(partial.toAttribute),
      partial :: Nil
    )
  }
}

<span class="keyword">def</span> <span class="function">mergeHLL</span>(<span class="key">e</span>: Column): Column = MergeHLL(e.expr)
</pre></div>
</div>
 </figure></notextile></div>

<p>After that writing aggregations becomes really easy task, and your expressions will look like “native” DataFrame code, which is really nice, and super
easy to read and reason about. </p>

<p>Also it works much faster then solving this problem with scala transformations on top of <code>RDD[Row]</code>, as Spark catalyst optimizer can executed optimized
plan and reduce amount of data that needs to be shuffled between spark nodes.</p>

<p>And finally it’s so much easier to manage mutable state. Spark encourage you to use immutable transformations, and it’s really cool until you need
extreme performance from your code. For example if you are using something like <code>reduce</code> or <code>aggregateByKey</code> you don’t really know when and where
your function instantiated and when it’s done with <code>RDD</code> partition and result transferred to another Spark node for merge operation. With <code>AggregateExpression</code> 
you have explicit control over mutable state, and it’s totally safe to accumulate mutable state during execution for single partition, and at the end when
you’ll need to send data to other node you can create immutable copy.</p>

<p>In this particular case using mutable <code>HyperLogLog</code> merge implementation helped to speed up computation time almost 10x times. For each partition <code>HyperLogLog</code> state
accumulated in single mutable <code>Array[Byte]</code> and at the end when data needs to be transferred somewhere else for merging with another partition, immutable copy is created.</p>

<h3 id="some-fancy-aggregates-with-dataframe-api">Some fancy aggregates with DataFrame Api</h3>

<p>You can write much more complicated aggregation functions, for example to compute aggregate based on multiple columns. Here is code sample from 
our audience analytics project.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>

<span class="keyword">case</span> <span class="type">class</span> <span class="class">SegmentEstimate</span>(<span class="key">cookieHLL</span>: HyperLogLog, <span class="key">clickHLL</span>: HyperLogLog)

type SegmentName = <span class="predefined-type">String</span>

val <span class="key">dailyEstimates</span>: RDD[(SegmentName, <span class="predefined-type">Map</span>[LocalDate, SegmentEstimate])] =
    segments.groupBy(segment_name).agg(
      segment_name,
      mergeDailySegmentEstimates(
        mkDailySegmentEstimate(      <span class="comment">// -- Map[LocalDate, SegmentEstimate]</span>
          dt,
          mkSegmentEstimate(         <span class="comment">// -- SegmentEstimate(cookieHLL, clickHLL)</span>
            cookie_hll,
            click_hll)
        )
      )
    )
</pre></div>
</div>
 </figure></notextile></div>

<p>This codes computes daily audience aggregated by segment. Using Spark <code>PartialAggregate</code> function 
saves a lot of network traffic and minimizes distributed shuffle size. </p>

<p>This aggregation is possible because of nice properties of <code>Monoid</code></p>

<ul>
  <li><code>HyperLogLog</code> is a <code>Monoid</code> (has <code>zero</code> and <code>plus</code> operations)</li>
  <li><code>SegmentEstimate</code> is a <code>Monoid</code> (tuple of two monoids)</li>
  <li><code>Map[K, SegmentEstimate]</code> is a <code>Monoid</code> (map with value monoid value type is monoid itself)</li>
</ul>

<h3 id="problems-with-custom-aggregation-functions">Problems with custom aggregation functions</h3>

<ul>
  <li>Right now it’s closed API, so you need to place all your code under <code>org.apache.spark.sql</code> package.</li>
  <li>It’s no guarantee that it will work in next Spark release.</li>
  <li>If you want to try, I suggest you to start with <code>org.apache.spark.sql.catalyst.expressions.Sum</code> as example.</li>
</ul>

<h2 id="spark-as-in-memory-sql-database">Spark as in-memory SQL database</h2>

<p>We use Spark as in-memory database that serves SQL (composed with DataFrame Api) queries. </p>

<p>People tend to think about spark with very batch oriented mindset. Start Spark cluster in Yarn, do computation, kill cluster. Submit you application to 
standalone Spark cluster (Mesos), kill it. Biggest problem with this approach that after your application is done, and JVM is killed, <code>SparkContext</code> is lost,
and even if you are running Spark in standalone mode, all data cached by your application is lost.</p>

<p>We use Spark in totally different way. We start Spark cluster in Yarn, load data to it from HDFS, cache it in memory, and <strong>do not shutdown</strong>. We
keep JVM running, it holds a reference to <code>SparkContext</code> and keeps all the data in memory on worker nodes.</p>

<p>Our backend application is essentially very simpre REST/JSON server built with Spray, that holds <code>SparkContext</code> reference, receive requests via
URL parameters, runs queries in Spark and return response in JSON.</p>

<p>Right now (July 2015) we have data starting from April, and it’s around 100g cached in 40 nodes. We need to keep 1 year history, so we don’t expect
more than 500g. And we are very confident that we can scale horizontally without seriously affecting performance. Right now average 
request response time is 1-2 seconds which is really good for our use case.</p>

<h2 id="spark-best-practices">Spark Best practices</h2>

<p>Here are configuration options that I found really useful for our specific task. You can find more details about each of them in Spark guide.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
- spark.scheduler.mode=FAIR
- spark.yarn.executor.memoryOverhead=4000
- spark.sql.autoBroadcastJoinThreshold=300000000 // ~300mb
- spark.serializer=org.apache.spark.serializer.KryoSerializer
- spark.speculation=true
</pre></div>
</div>
 </figure></notextile></div>

<p>Also I found that it’s really important to repartition your dataset if you are going to cache it and use for queries. Optimal number of partitions is
around 4-6 for each executor core, with 40 nodes and 6 executor cores we use 1000 partitions for best performance.</p>

<p>If you have too many partitions Spark will spend too much time for coordination, and receiving results from all partitions. If too small, you might have
problems with too big block during shuffle that can kill not only performance, but all your cluster: <a href="https://issues.apache.org/jira/browse/SPARK-1476">SPARK-1476</a></p>

<h2 id="other-options">Other Options</h2>

<p>Before starting this project we were evaluating some other options</p>

<h3 id="hive">Hive</h3>

<p>Obviously it’s too slow for interactive UI backend, but we found it really useful for batch data processing. We use it to process raw logs
and build aggregated tables with <code>HyperLogLog</code> inside.</p>

<h3 id="impala">Impala</h3>

<p>To get good performance out of Impala it’s required to write C++ user defined functions, and it’s was not the task that I wanted to do. Also 
I’m not confident that even with custom C++ function Impala can show performance that we need.</p>

<h4 id="druid">Druid</h4>

<p><a href="http://druid.io/">Druid</a> is really interesting project, and it’s used in another project at Collective for slightly different problem, 
but it’s not in production yet.</p>

<ul>
  <li>Managing separate Druid cluster - it’s not the task that I want to do</li>
  <li>We have batch oriented process - and druid data ingestion is stream based</li>
  <li>Bad support for some of type of queries that we need - if I need to know intersection of some particular ad with all segments, in case of druid it will be 10k (number of segments) queries, and it will obviously fail to complete in 1-2 seconds </li>
  <li>Not clear how get data back from Druid - it’s hard to get data back from Druid later, if it will turn out that it doesn’t solve out problems well</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Spark is Awesome! I didn’t have any major issues with it, and it just works! New DataFrame API is amazing, and we are going to build lot’s of new cool projects at Collective
with Spar MLLib and GraphX, and I’m pretty sure they all will be successful.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Feature Engineering at Scale With Spark]]></title>
    <link href="http://eugenezhulenev.com/blog/2015/06/10/feature-engineering-at-scale/"/>
    <updated>2015-06-10T23:02:45-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2015/06/10/feature-engineering-at-scale</id>
    <content type="html"><![CDATA[<blockquote>
  <p>Check Model Matrix <a href="http://collectivemedia.github.io/modelmatrix/">Website</a> and <a href="https://github.com/collectivemedia/modelmatrix">Github project</a>.</p>
</blockquote>

<p>At <a href="http://collective.com">Collective</a> we are in programmatic advertisement business, it means that all our
advertisement decisions (what ad to show, to whom and at what time) are driven by models. We do a lot of 
machine learning, build thousands predictive models and use them to make millions decision per second.</p>

<h4 id="how-do-we-get-the-most-out-of-our-data-for-predictive-modeling">How do we get the most out of our data for predictive modeling?</h4>

<p>Success of all Machine Learning algorithms depends on data that you put into it, the better the features you choose, the
better the results you will achieve.</p>

<blockquote>
  <p>Feature Engineering is the process of using domain knowledge of the data to create features that make machine learning algorithms work better.</p>
</blockquote>

<p>In Ad-Tech it’s finite pieces of information about users that we can put into our models, and it’s 
almost the same across all companies in industry, we don’t have access to any anonymous data
like real name and age, interests on Facebook etc. It really matter how creative you are to get maximum from the data you have,
and how fast you can iterate and test new idea.</p>

<p>In 2014 Collective data science team published <a href="http://arxiv.org/abs/1402.6076">Machine Learning at Scale</a> paper that
describes our approach and trade-offs for audience optimization. In 2015 we solve the same problems, but
using new technologies (Spark and Spark MLLib) at even bigger scale. I want to show the tool that I built specifically 
to handle feature engineering/selection problem, and which is open sources now.</p>

<h2 id="model-matrix">Model Matrix</h2>

<!-- more -->

<h3 id="feature-transformation">Feature Transformation</h3>

<p>Imagine impression log that is used to train predictive model</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
visitor_id  | ad_campaign     | ad_id | ad_ctr     | pub_site            | state | city         | price | timestamp     
----------- | --------------- | ----- | ---------- | ------------------- | ----- | ------------ | ----- | ------------- 
bob         | Nike_Sport      | 1     | 0.01       | http://bbc.com      | NY    | New York     | 0.17  | 1431032702135  
bill        | Burgers_Co      | 2     | 0.005      | http://cnn.com      | CA    | Los Angeles  | 0.42  | 1431032705167 
mary        | Macys           | 3     | 0.015      | http://fashion.com  | CA    | Los Angeles  | 0.19  | 1431032708384 
</pre></div>
</div>
 </figure></notextile></div>

<p>Producing a feature vector for every visitor (cookie) row and every piece of information about a 
visitor as an p-size vector, where p is the number of predictor variables multiplied by cardinality 
of each variable (number of states in US, number of unique websites, etc …). It is impractical 
both from the data processing standpoint and because the resulting vector would only have 
about 1 in 100,000 non-zero elements.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
 visitor_id  | Nike_Sport | Burgers_Co | Macys | NY  | CA  | ... 
 ----------- | ---------- | ---------- | ----- | --- | --- | --- 
 bob         | 1.0        |            |       | 1.0 |     | ... 
 bill        |            | 1.0        |       |     | 1.0 | ... 
 mary        |            |            | 1.0   |     | 1.0 | ... 
</pre></div>
</div>
 </figure></notextile></div>

<p>Model Matrix uses feature transformations (top, index, binning) to reduce dimensionality to arrive 
at between one and two thousand predictor variables, with data sparsity of about 1 in 10. It removes 
irrelevant and low frequency predictor values from the model, and transforms continuous 
variable into bins of the same size.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>   
 visitor_id  | Nike | OtherAd | NY  | OtherState | price ∈ [0.01, 0.20) | price ∈ [0.20, 0.90) | ... 
 ----------- | ---- | ------- | --- | ---------- | -------------------- | -------------------- | --- 
 bob         | 1.0  |         | 1.0 |            | 1.0                  |                      | ... 
 bill        |      | 1.0     |     | 1.0        |                      | 1.0                  | ... 
 mary        |      | 1.0     |     | 1.0        |                      | 1.0                  | ... 
</pre></div>
</div>
 </figure></notextile></div>

<p>Transformation definitions in scala:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
sealed trait Transform

<span class="comment">/**
 * Absence of transformation
 */</span>
<span class="keyword">case</span> object <span class="predefined-type">Identity</span> <span class="directive">extends</span> Transform

<span class="comment">/**
 * For distinct values of the column, find top values
 * by a quantity that cumulatively cover a given percentage
 * of this quantity. For example, find the top DMAs that
 * represent 99% of cookies, or find top sites that
 * are responsible for 90% of impressions.
 *
 * @param cover      cumulative cover percentage
 * @param allOther   include feature for all other values
 */</span>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">Top</span>(<span class="key">cover</span>: <span class="predefined-type">Double</span>, <span class="key">allOther</span>: <span class="predefined-type">Boolean</span>) <span class="directive">extends</span> Transform

<span class="comment">/**
 * For distinct values of the column, find the values
 * with at least the minimum support in the data set.
 * Support for a value is defined as the percentage of a
 * total quantity that have that value. For example,
 * find segments that appear for at least 1% of the cookies.
 *
 * @param support    support percentage
 * @param allOther   include feature for all other values
 */</span>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">Index</span>(<span class="key">support</span>: <span class="predefined-type">Double</span>, <span class="key">allOther</span>: <span class="predefined-type">Boolean</span>) <span class="directive">extends</span> Transform

<span class="comment">/**
 * Break the values in the column into bins with roughly the same number of points.
 *
 * @param nbins target number of bins
 * @param minPoints minimum number of points in single bin
 * @param minPercents minimum percent of points in a bin (0-100).
 *                    The larger of absolute number and percent points is used.
 */</span>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">Bins</span>(<span class="key">nbins</span>: Int, <span class="key">minPoints</span>: Int = <span class="integer">0</span>, <span class="key">minPercents</span>: <span class="predefined-type">Double</span> = <span class="float">0.0</span>) <span class="directive">extends</span> Transform
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="transformed-columns">Transformed Columns</h3>

<h4 id="categorical-transformation">Categorical Transformation</h4>

<p>A column calculated by applying top or index transform function, each columns id corresponds 
to one unique value from input data set. SourceValue is encoded as ByteVector unique value from 
input column and used later for featurization. </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">CategoricalTransformer</span>(
  <span class="key">features</span>: DataFrame <span class="error">@</span><span class="error">@</span> <span class="predefined-type">Transformer</span>.Features
) <span class="directive">extends</span> <span class="predefined-type">Transformer</span>(features) {

  <span class="keyword">def</span> <span class="function">transform</span>(<span class="key">feature</span>: TypedModelFeature): Seq[CategoricalColumn]
  
}
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
sealed trait CategoricalColumn {
  <span class="keyword">def</span> <span class="key">columnId</span>: Int
  <span class="keyword">def</span> <span class="key">count</span>: <span class="predefined-type">Long</span>
  <span class="keyword">def</span> <span class="key">cumulativeCount</span>: <span class="predefined-type">Long</span>
}

object CategoricalColumn {

  <span class="keyword">case</span> <span class="type">class</span> <span class="class">CategoricalValue</span>(
    <span class="key">columnId</span>: Int,
    <span class="key">sourceName</span>: <span class="predefined-type">String</span>,
    <span class="key">sourceValue</span>: ByteVector,
    <span class="key">count</span>: <span class="predefined-type">Long</span>,
    <span class="key">cumulativeCount</span>: <span class="predefined-type">Long</span>
  ) <span class="directive">extends</span> CategoricalColumn 

  <span class="keyword">case</span> <span class="type">class</span> <span class="class">AllOther</span>(
    <span class="key">columnId</span>: Int,
    <span class="key">count</span>: <span class="predefined-type">Long</span>,
    <span class="key">cumulativeCount</span>: <span class="predefined-type">Long</span>
  ) <span class="directive">extends</span> CategoricalColumn 
  
}
</pre></div>
</div>
 </figure></notextile></div>

<h4 id="bin-column">Bin Column</h4>

<p>A column calculated by applying binning transform function.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">BinsTransformer</span>(
  <span class="key">input</span>: DataFrame <span class="error">@</span><span class="error">@</span> <span class="predefined-type">Transformer</span>.Features
) <span class="directive">extends</span> <span class="predefined-type">Transformer</span>(input) with Binner {

  <span class="keyword">def</span> <span class="function">transform</span>(<span class="key">feature</span>: TypedModelFeature): Seq[BinColumn] = {
  
}
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">BinValue</span>(
    <span class="key">columnId</span>: Int,
    <span class="key">low</span>: <span class="predefined-type">Double</span>,
    <span class="key">high</span>: <span class="predefined-type">Double</span>,
    <span class="key">count</span>: <span class="predefined-type">Long</span>,
    <span class="key">sampleSize</span>: <span class="predefined-type">Long</span>
  ) 
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="building-model-matrix-instance">Building Model Matrix Instance</h3>

<p>Model Matrix instance contains information about shape of the training data, what transformations (categorical and binning)
are required to apply to input data in order to obtain feature vector that will got into machine learning
algorithm.</p>

<p>Building model matrix instance described well in <a href="http://collectivemedia.github.io/modelmatrix/doc/cli.html">command line interface documentation</a>.</p>

<h3 id="featurizing-your-data">Featurizing your data</h3>

<p>When you have model matrix instance, you can apply it to multiple input data sets. For example in Collective
we build model matrix instance once a week or even month, and use it for building models from daily/hourly data.
It gives us nice property: all models have the same columns, and it’s easy to compare them.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>

<span class="comment">// Similar to Spark LabeledPoint</span>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">IdentifiedPoint</span>(<span class="key">id</span>: Any, <span class="key">features</span>: <span class="predefined-type">Vector</span>)

<span class="type">class</span> <span class="class">Featurization</span>(<span class="key">features</span>: Seq[ModelInstanceFeature]) <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {

  <span class="comment">// Check that all input features belong to the same model instance</span>
  <span class="directive">private</span> val instances = features.map(_.modelInstanceId).toSet
  require(instances.size == <span class="integer">1</span>, 
    s<span class="string"><span class="delimiter">&quot;</span><span class="content">Features belong to different model instances: </span><span class="inline"><span class="inline-delimiter">$</span>instances</span><span class="delimiter">&quot;</span></span>)

  <span class="comment">// Maximum columns id in instance features</span>
  <span class="directive">private</span> val totalNumberOfColumns = features.flatMap {
    <span class="keyword">case</span> ModelInstanceIdentityFeature(_, _, _, _, columnId) =&gt; Seq(columnId)
    <span class="keyword">case</span> ModelInstanceTopFeature(_, _, _, _, cols) =&gt; cols.map(_.columnId)
    <span class="keyword">case</span> ModelInstanceIndexFeature(_, _, _, _, cols) =&gt; cols.map(_.columnId)
    <span class="keyword">case</span> ModelInstanceBinsFeature(_, _, _, _, cols) =&gt; cols.map(_.columnId)
  }.max


  <span class="comment">/**
   * Featurize input dataset
   *
   * @return id data type and featurized rows
   */</span>
  <span class="keyword">def</span> <span class="function">featurize</span>(
    <span class="key">input</span>: DataFrame <span class="error">@</span><span class="error">@</span> FeaturesWithId, 
    <span class="key">idColumn</span>: <span class="predefined-type">String</span>
  ): (DataType, RDD[IdentifiedPoint]) = {
  
    log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Extract features from input DataFrame with id column: </span><span class="inline"><span class="inline-delimiter">$</span>idColumn</span><span class="content">. </span><span class="delimiter">&quot;</span></span> + 
             s<span class="string"><span class="delimiter">&quot;</span><span class="content">Total number of columns: </span><span class="inline"><span class="inline-delimiter">$</span>totalNumberOfColumns</span><span class="delimiter">&quot;</span></span>)
    
    ...
    
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="results">Results</h3>

<p>Model Matrix is open sourced, and available on <a href="https://github.com/collectivemedia/modelmatrix">Github</a>, lot’s of 
documentation on <a href="http://collectivemedia.github.io/modelmatrix/">Website</a>.</p>

<p>We use it at <a href="http://collective.com">Collective</a> to define our models and it works for us really well.</p>

<p>You can continue your reading with <a href="http://arxiv.org/abs/1402.6076">Machine Learning at Scale</a> paper, 
to get more data science focused details about our modeling approach.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building Twitter Live Stream Analytics With Spark and Cassandra]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/11/20/twitter-analytics-with-spark/"/>
    <updated>2014-11-20T20:01:15-05:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/11/20/twitter-analytics-with-spark</id>
    <content type="html"><![CDATA[<blockquote>
  <p>This is repost of my article from <a href="http://io.pellucid.com/blog/building-twitter-live-stream-analytics-with-spark-and-cassandra">Pellucid Tech Blog</a></p>
</blockquote>

<h3 id="background">Background</h3>

<p>At <a href="http://pellucid.com">Pellucid Analytics</a> we we are building a platform that
automates and simplifies the creation of data-driven chartbooks, so that it takes
minutes instead of hours to get from raw data to powerful visualizations and compelling stories.</p>

<p>One of industries we are focusing on is Investment Banking. We are helping IB advisory
professionals build pitch-books, and provide them with analytical and quantitative support
to sell their ideas. Comparable Companies Analysis is central to this business.</p>

<blockquote>
  <p>Comparable company analysis starts with establishing a peer group consisting of similar companies of similar size in the same industry and region.</p>
</blockquote>

<p>The problem we are faced with is finding a scalable solution to establish a peer group for any chosen company.</p>

<!-- more -->

<h3 id="approaches-that-we-tried">Approaches That We Tried</h3>

<h4 id="company-industry">Company Industry</h4>

<p>Data vendors provide <a href="http://en.wikipedia.org/wiki/Industry_classification">industry classification</a>
for each company, and it helps a lot in industries like retail (Wal-Mart is good comparable to Costco),
energy (Chevron and Exxon Mobil) but it stumbles with many other companies. People tend to compare
Amazon with Google as a two major players in it business, but data vendors tend to put Amazon in retail industry with Wal-Mart/Costco as comparables.</p>

<h4 id="company-financials-and-valuation-multiples">Company Financials and Valuation Multiples</h4>

<p>We tried cluster analysis and k-nearest neighbors to group companies based on their
financials (Sales, Revenue) and valuation multiples (EV/EBIDTA, P/E). However assumptions
that similar companies will have similar valuations multiples is wrong. People compare
Twitter with Facebook as two biggest companies in social media, but based on their financials
they don’t have too much in common. Facebook 2013 revenue is almost $8 billion and Twitter has only $600 million.</p>

<h3 id="novel-approach">Novel Approach</h3>

<p>We came up with an idea that if companies are often mentioned in news articles and tweets together, it’s probably a sign that people think about them as comparable companies. In this post I’ll show how we built proof of concept for this idea with Spark, Spark Streaming and Cassandra. We use only Twitter live stream data for now, accessing high quality news data is a bit more complicated problem.</p>

<!-- more -->

<p>Let’s take for example this tweet from CNN:</p>

<blockquote class="twitter-tweet" lang="en"><p>Trying to spot the next <a href="https://twitter.com/search?q=%24FB&amp;src=ctag">$FB</a> or <a href="https://twitter.com/search?q=%24TWTR&amp;src=ctag">$TWTR</a>? These 10 startups are worth keeping an eye on <a href="http://t.co/FEKNtm7QqB">http://t.co/FEKNtm7QqB</a></p>&mdash; CNN Public Relations (@CNNPR) <a href="https://twitter.com/CNNPR/status/518083527863435264">October 3, 2014</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>From this tweet we can derive 2 mentions for 2 companies. For Facebook it will be Twitter and vice-versa. If we collect tweets for all companies over some period of time, and take a ratio of joint appearance in same tweet as a measure of “similarity”, we can build comparable company recommendations based on this measure.</p>

<h3 id="data-model">Data Model</h3>

<p>We use <a href="http://cassandra.apache.org/">Cassandra</a> to store all mentions, aggregates and final recommendations.
We use <a href="https://github.com/websudos/phantom">Phantom DSL</a> for scala to define schema
and for most of Cassandra operations (spark integration is not yet supported in Phantom).</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">/**
 * Mention of focus company
 *
 * @param ticker   ticker of focus company
 * @param source   source of this mention (Twitter, RSS, etc...)
 * @param sourceId source specific id
 * @param time     time
 * @param mentions set of other tickers including focus ticker itself
 */</span>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">Mention</span>(<span class="key">ticker</span>: Ticker, <span class="key">source</span>: <span class="predefined-type">String</span>, <span class="key">sourceId</span>: <span class="predefined-type">String</span>, <span class="key">time</span>: DateTime, <span class="key">mentions</span>: <span class="predefined-type">Set</span>[Ticker])

sealed <span class="type">class</span> <span class="class">MentionRecord</span> <span class="directive">extends</span> CassandraTable[MentionRecord, Mention] with <span class="predefined-type">Serializable</span> {

  override val <span class="key">tableName</span>: <span class="predefined-type">String</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">mention</span><span class="delimiter">&quot;</span></span>

  object ticker    <span class="directive">extends</span> StringColumn    (<span class="local-variable">this</span>)  with PartitionKey[<span class="predefined-type">String</span>]
  object source    <span class="directive">extends</span> StringColumn    (<span class="local-variable">this</span>)  with PrimaryKey[<span class="predefined-type">String</span>]
  object time      <span class="directive">extends</span> DateTimeColumn  (<span class="local-variable">this</span>)  with PrimaryKey[DateTime]
  object source_id <span class="directive">extends</span> StringColumn    (<span class="local-variable">this</span>)  with PrimaryKey[<span class="predefined-type">String</span>]
  object mentions  <span class="directive">extends</span> SetColumn[MentionRecord, Mention, <span class="predefined-type">String</span>] (<span class="local-variable">this</span>)

  <span class="keyword">def</span> <span class="function">fromRow</span>(<span class="key">r</span>: Row): Mention = {
    Mention(Ticker(ticker(r)), source(r), source_id(r), time(r), mentions(r) map Ticker)
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">/**
 * Count mentions for each ticker pair
 *
 * @param ticker        ticker of focus company
 * @param mentionedWith mentioned with this ticker
 * @param count         number of mentions
 */</span>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">MentionsAggregate</span>(<span class="key">ticker</span>: Ticker, <span class="key">mentionedWith</span>: Ticker, <span class="key">count</span>: <span class="predefined-type">Long</span>)

sealed <span class="type">class</span> <span class="class">MentionsAggregateRecord</span> <span class="directive">extends</span> CassandraTable[MentionsAggregateRecord, MentionsAggregate] {

  override val <span class="key">tableName</span>: <span class="predefined-type">String</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">mentions_aggregate</span><span class="delimiter">&quot;</span></span>

  object ticker         <span class="directive">extends</span> StringColumn (<span class="local-variable">this</span>) with PartitionKey[<span class="predefined-type">String</span>]
  object mentioned_with <span class="directive">extends</span> StringColumn (<span class="local-variable">this</span>) with PrimaryKey[<span class="predefined-type">String</span>]
  object counter        <span class="directive">extends</span> LongColumn   (<span class="local-variable">this</span>)

  <span class="keyword">def</span> <span class="function">fromRow</span>(<span class="key">r</span>: Row): MentionsAggregate = {
    MentionsAggregate(Ticker(ticker(r)), Ticker(mentioned_with(r)), counter(r))
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">/**
 * Recommendation built based on company mentions with other companies
 *
 * @param ticker         focus company ticker
 * @position             recommendation position
 * @param recommendation recommended company ticker
 * @param p              number of times recommended company mentioned together
 *                       with focus company divided by total focus company mentions
 */</span>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">Recommendation</span>(<span class="key">ticker</span>: Ticker, <span class="key">position</span>: <span class="predefined-type">Long</span>, <span class="key">recommendation</span>: Ticker, <span class="key">p</span>: <span class="predefined-type">Double</span>)

sealed <span class="type">class</span> <span class="class">RecommendationRecord</span> <span class="directive">extends</span> CassandraTable[RecommendationRecord, Recommendation] {

  override val <span class="key">tableName</span>: <span class="predefined-type">String</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">recommendation</span><span class="delimiter">&quot;</span></span>

  object ticker         <span class="directive">extends</span> StringColumn (<span class="local-variable">this</span>) with PartitionKey[<span class="predefined-type">String</span>]
  object position       <span class="directive">extends</span> LongColumn   (<span class="local-variable">this</span>) with PrimaryKey[<span class="predefined-type">Long</span>]
  object recommendation <span class="directive">extends</span> StringColumn (<span class="local-variable">this</span>)
  object p              <span class="directive">extends</span> DoubleColumn (<span class="local-variable">this</span>)

  <span class="keyword">def</span> <span class="function">fromRow</span>(<span class="key">r</span>: Row): Recommendation = {
    Recommendation(Ticker(ticker(r)), position(r), Ticker(recommendation(r)), p(r))
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="ingest-real-time-twitter-stream">Ingest Real-Time Twitter Stream</h3>

<p>We use <a href="https://spark.apache.org/streaming/">Spark Streaming</a> Twitter integration to subscribe for
real-time twitter updates, then we extract company mentions and put them to Cassandra. Unfortunately Phantom
doesn’t support Spark yet, so we used <a href="https://github.com/datastax/spark-cassandra-connector">Datastax Spark Cassandra Connector</a>
with custom type mappers to map from Phantom-record types into Cassandra tables.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">MentionStreamFunctions</span>(<span class="annotation">@transient</span> <span class="key">stream</span>: DStream[Mention]) <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {

  <span class="keyword">import</span> <span class="include">TickerTypeConverter._</span>

  TypeConverter.registerConverter(StringToTickerTypeConverter)
  TypeConverter.registerConverter(TickerToStringTypeConverter)

  implicit object MentionMapper <span class="directive">extends</span> DefaultColumnMapper[Mention](<span class="predefined-type">Map</span>(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">ticker</span><span class="delimiter">&quot;</span></span>        -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">ticker</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>        -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">source</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">sourceId</span><span class="delimiter">&quot;</span></span>      -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">source_id</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">time</span><span class="delimiter">&quot;</span></span>          -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">time</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">mentions</span><span class="delimiter">&quot;</span></span>      -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">mentions</span><span class="delimiter">&quot;</span></span>
  ))

  <span class="keyword">def</span> <span class="function">saveMentionsToCassandra</span>(<span class="key">keyspace</span>: <span class="predefined-type">String</span>) = {
    stream.saveToCassandra(keyspace, MentionRecord.tableName)
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
  <span class="directive">private</span> val filters = Companies.load().map(c =&gt; s<span class="string"><span class="delimiter">&quot;</span><span class="content">$</span><span class="content">$</span><span class="inline"><span class="inline-delimiter">${</span>c.ticker.value<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)

  val sc = <span class="keyword">new</span> SparkContext(sparkConf)
  val ssc = <span class="keyword">new</span> StreamingContext(sc, Seconds(<span class="integer">2</span>))

  val stream = TwitterUtils.createStream(ssc, None, filters = filters)

  <span class="comment">// Save Twitter Stream to cassandra</span>
  stream.foreachRDD(updates =&gt; log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Received Twitter stream updates. Count: </span><span class="inline"><span class="inline-delimiter">${</span>updates.count()<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>))
  stream.extractMentions.saveMentionsToCassandra(keySpace)

  <span class="comment">// Start Streaming Application</span>
  ssc.start()
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="spark-for-aggregation-and-recommendation">Spark For Aggregation and Recommendation</h3>

<p>To come up with comparable company recommendation we use 2-step process.</p>

<h5 id="count-mentions-for-each-pair-of-tickers">1. Count mentions for each pair of tickers</h5>

<p>After <code>Mentions</code> table loaded in Spark as <code>RDD[Mention]</code> we extract pairs of tickers,
and it enables bunch of aggregate and reduce functions from Spark <code>PairRDDFunctions</code>.
With <code>aggregateByKey</code> and given combine functions we efficiently build counter map <code>Map[Ticker, Long]</code> for each
ticker distributed in cluster. From single <code>Map[Ticker, Long]</code> we emit multiple aggregates for each ticket pair.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">AggregateMentions</span>(<span class="annotation">@transient</span> <span class="key">sc</span>: SparkContext, <span class="key">keyspace</span>: <span class="predefined-type">String</span>)
  <span class="directive">extends</span> CassandraMappers with <span class="predefined-type">Serializable</span> {

  <span class="directive">private</span> type Counter = <span class="predefined-type">Map</span>[Ticker, <span class="predefined-type">Long</span>]

  <span class="directive">private</span> implicit lazy val summ = Semigroup.instance[<span class="predefined-type">Long</span>](_ + _)

  <span class="directive">private</span> lazy val <span class="key">seqOp</span>: (Counter, Ticker) =&gt; Counter = {
    <span class="keyword">case</span> (counter, ticker) <span class="keyword">if</span> counter.isDefinedAt(ticker) =&gt; counter.updated(ticker, counter(ticker) + <span class="integer">1</span>)
    <span class="keyword">case</span> (counter, ticker) =&gt; counter + (ticker -&gt; <span class="integer">1</span>)
  }

  <span class="directive">private</span> lazy val <span class="key">combOp</span>: (Counter, Counter) =&gt; Counter = {
    <span class="keyword">case</span> (l, r) =&gt; implicitly[Monoid[Counter]].append(l, r)
  }

  <span class="keyword">def</span> <span class="function">aggregate</span>(): Unit = {
    <span class="comment">// Emit pairs of (Focus Company Ticker, Mentioned With)</span>
    val pairs = sc.cassandraTable[Mention](keyspace, MentionRecord.tableName).
      flatMap(mention =&gt; mention.mentions.map((mention.ticker, _)))

    <span class="comment">// Calculate mentions for each ticker</span>
    val aggregated = pairs.aggregateByKey(<span class="predefined-type">Map</span>.empty[Ticker, <span class="predefined-type">Long</span>])(seqOp, combOp)

    <span class="comment">// Build MentionsAggregate from counters</span>
    val mentionsAggregate = aggregated flatMap {
      <span class="keyword">case</span> (ticker, counter) =&gt; counter map {
        <span class="keyword">case</span> (mentionedWith, count) =&gt; MentionsAggregate(ticker, mentionedWith, count)
      }
    }

    mentionsAggregate.saveToCassandra(keyspace, MentionsAggregateRecord.tableName)
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<h5 id="sort-aggregates-and-build-recommendations">2. Sort aggregates and build recommendations</h5>

<p>After aggregates computed, we sort them globally and then group them by key (Ticker). After
all aggregates grouped we produce <code>Recommendation</code> in single traverse distributed for each key.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">Recommend</span>(<span class="annotation">@transient</span> <span class="key">sc</span>: SparkContext, <span class="key">keyspace</span>: <span class="predefined-type">String</span>)
  <span class="directive">extends</span> CassandraMappers with <span class="predefined-type">Serializable</span> {

  <span class="directive">private</span> <span class="keyword">def</span> <span class="key">toRecommendation</span>: (MentionsAggregate, Int) =&gt; Recommendation = {
    var <span class="key">totalMentions</span>: <span class="predefined-type">Option</span>[<span class="predefined-type">Long</span>] = None

    {
      <span class="keyword">case</span> (aggregate, idx) <span class="keyword">if</span> totalMentions.isEmpty =&gt;
        totalMentions = Some(aggregate.count)
        Recommendation(aggregate.ticker, idx, aggregate.mentionedWith, <span class="integer">1</span>)

      <span class="keyword">case</span> (aggregate, idx) =&gt;
        Recommendation(aggregate.ticker, idx,
                       aggregate.mentionedWith,
                       aggregate.count.toDouble / totalMentions.get)
    }
  }

  <span class="keyword">def</span> <span class="function">recommend</span>(): Unit = {
    val aggregates = sc.
               cassandraTable[MentionsAggregate](keyspace, MentionsAggregateRecord.tableName).
               sortBy(_.count, ascending = <span class="predefined-constant">false</span>)

    val recommendations = aggregates.
      groupBy(_.ticker).
      mapValues(_.zipWithIndex).
      flatMapValues(_ map toRecommendation.tupled).values

    recommendations.saveToCassandra(keyspace, RecommendationRecord.tableName)
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="results">Results</h3>

<p>You can check comparable company recommendations build from Twitter stream using <a href="http://pellucidanalytics.github.io/tweet-driven-comparable-companies/comparables/comps.html">this link</a>.</p>

<p>Cassandra and Spark works perfectly together and allows you to build scalable data-driven applications, that are super easy to scale out and handle gigabytes and terabytes of data. In this particular case, it’s probably an overkill. Twitter doesn’t have enough finance-related activity to produce serious load. However it’s easy to extend this application and add other streams: Bloomberg News Feed, Thompson Reuters, etc.</p>

<blockquote>
  <p>The code for this application app can be found on <a href="https://github.com/ezhulenev/tweet-driven-comparable-companies">Github</a></p>
</blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Stock Price Prediction With Big Data and Machine Learning]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/11/14/stock-price-prediction-with-big-data-and-machine-learning/"/>
    <updated>2014-11-14T21:03:35-05:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/11/14/stock-price-prediction-with-big-data-and-machine-learning</id>
    <content type="html"><![CDATA[<p>Apache Spark and Spark MLLib for building price movement prediction model from order log data.</p>

<blockquote>
  <p>The code for this application app can be found on <a href="https://github.com/ezhulenev/orderbook-dynamics">Github</a></p>
</blockquote>

<h3 id="synopsis">Synopsis</h3>

<p>This post is based on <a href="https://raw.github.com/ezhulenev/scala-openbook/master/assets/Modeling-high-frequency-limit-order-book-dynamics-with-support-vector-machines.pdf">Modeling high-frequency limit order book dynamics with support vector machines</a> paper.
Roughly speaking I’m implementing ideas introduced in this paper in scala with <a href="https://spark.apache.org/">Spark</a> and <a href="https://spark.apache.org/mllib/">Spark MLLib</a>.
Authors are using sampling, I’m going to use full order log from <a href="http://www.nyxdata.com/Data-Products/NYSE-OpenBook-History">NYSE</a> (sample data is available from <a href="ftp://ftp.nyxdata.com/Historical%20Data%20Samples/TAQ%20NYSE%20OpenBook/">NYSE FTP</a>), just because
I can easily do it with Spark. Instead of using SVM, I’m going to use <a href="http://spark.apache.org/docs/latest/mllib-decision-tree.html">Decision Tree</a> algorithm for classification,
because in Spark MLLib it supports multiclass classification out of the box.</p>

<p>If you want to get deep understanding of the problem and proposed solution, you need to read the paper.
I’m going to give high level overview of the problem in less academic language, in one or two paragraphs.</p>

<blockquote>
  <p>Predictive modelling is the process by which a model is created or chosen to try to best predict the probability of an outcome.</p>
</blockquote>

<!-- more -->

<h4 id="model-architecture">Model Architecture</h4>

<p>Authors are proposing framework for extracting feature vectors from from raw order log data, that can be used as input to
machine learning classification method (SVM or Decision Tree for example) to predict price movement (Up, Down, Stationary). Given a set of training data
with assigned labels (price movement) classification algorithm builds a model that assigns new examples into one of pre-defined categories.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
Time(sec)            Price($)   Volume      Event Type      Direction
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
34203.011926972      598.68     10          submission      ask
34203.011926973      594.47     15          submission      bid
34203.011926974      594.49     20          submission      bid
34203.011926981      597.68     30          submission      ask
34203.011926991      594.47     15          execution       ask
34203.011927072      597.68     10          cancellation    ask
34203.011927082      599.88     12          submission      ask
34203.011927097      598.38     11          submission      ask
</pre></div>
</div>
 </figure></notextile></div>

<p>In the table, each row of the message book represents a trading event that could be either a order submission,
order cancellation, or order execution. The arrival time measured from midnight,
is in seconds and nanoseconds; price is in US dollars, and the Volume is in number of shares.
Ask - I’m selling and asking for this price, Bid - I want to buy for this price.</p>

<p>From this log it’s very easy to reconstruct state of order book after each entry. You can read more about <a href="http://www.investopedia.com/terms/o/order-book.asp">order book</a>
and <a href="http://www.investopedia.com/university/intro-to-order-types/limit-orders.asp">limit order book</a> in Investopedia,
I’m not going to dive into details. Concepts are super easy for understanding.</p>

<blockquote>
  <p>An electronic list of buy and sell orders for a specific security or financial instrument, organized by price level.</p>
</blockquote>

<h4 id="feature-extraction-and-training-data-preparation">Feature Extraction and Training Data Preparation</h4>

<p>After order books are reconstructed from order log, we can derive attributes, that will form feature vectors used as input to <code>classification model</code>.</p>

<p>Attributes are divided into three categories: basic, time-insensitive, and time-sensitive, all of which can be directly computed from the data.
Attributes in the basic set are the prices and volumes at both ask and bid sides up to n = 10 different levels (that is, price levels in the order book at a given moment),
which can be directly fetched from the order book. Attributes in the time-insensitive set are easily computed from the basic set at a single point in time.
Of this, bid-ask spread and mid-price, price ranges, as well as average price and volume at different price levels are calculated in feature sets <code>v2</code>, <code>v3</code>, and <code>v5</code>, respectively;
while <code>v5</code> is designed to track the accumulated differences of price and volume between ask and bid sides. By further taking the recent history of current data into consideration,
we devise the features in the time-sensitive set. More about calculating other attributes can be found in <a href="https://raw.github.com/ezhulenev/scala-openbook/master/assets/Modeling-high-frequency-limit-order-book-dynamics-with-support-vector-machines.pdf">original paper</a>.</p>

<p><img class="center" src="https://raw.github.com/ezhulenev/scala-openbook/master/assets/features.png" /></p>

<h4 id="labeling-training-data">Labeling Training Data</h4>

<p>To prepare training data for machine learning it’s also required to label each point with price movement observed over some time horizon (1 second fo example).
It’s straightforward task that only requires two order books: current order book and order book after some period of time.</p>

<p>I’m going to use <code>MeanPriceMove</code> label that can be: <code>Stationary</code>, <code>Up</code> or <code>Down</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>

trait <span class="predefined-type">Label</span>[L] <span class="directive">extends</span> <span class="predefined-type">Serializable</span> { label =&gt;
  <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">current</span>: OrderBook, <span class="key">future</span>: OrderBook): <span class="predefined-type">Option</span>[L]
}

sealed trait MeanPriceMove

object MeanPriceMove {
  <span class="keyword">case</span> object Up <span class="directive">extends</span> MeanPriceMove
  <span class="keyword">case</span> object Down <span class="directive">extends</span> MeanPriceMove
  <span class="keyword">case</span> object Stationary <span class="directive">extends</span> MeanPriceMove
}

object MeanPriceMovementLabel <span class="directive">extends</span> <span class="predefined-type">Label</span>[MeanPriceMove] {

  <span class="directive">private</span>[<span class="local-variable">this</span>] val basicSet = BasicSet.apply(BasicSet.Config.default)

  <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">current</span>: OrderBook, <span class="key">future</span>: OrderBook): <span class="predefined-type">Option</span>[MeanPriceMove] = {
    val currentMeanPrice = basicSet.meanPrice(current)
    val futureMeanPrice = basicSet.meanPrice(future)

    val <span class="key">cell</span>: Cell[MeanPriceMove] =
       currentMeanPrice.zipMap(futureMeanPrice) {
        (currentMeanValue, futureMeanValue) =&gt;
          <span class="keyword">if</span> (currentMeanValue == futureMeanValue)
            MeanPriceMove.Stationary
          <span class="keyword">else</span> <span class="keyword">if</span> (currentMeanValue &gt; futureMeanValue)
            MeanPriceMove.Down
          <span class="keyword">else</span>
            MeanPriceMove.Up
        }

    cell.toOption
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<h3 id="order-log-data">Order Log Data</h3>

<p>I’m going to use <a href="http://www.nyxdata.com/Data-Products/NYSE-OpenBook-History">NYSE TAQ OpenBook</a> orders data, and parse it with <a href="https://github.com/ezhulenev/scala-openbook">Scala OpenBook</a>
library. It’s easiest data set to get, free sample data for 2 trading days is available for download at <a href="ftp://ftp.nyxdata.com/Historical%20Data%20Samples/TAQ%20NYSE%20OpenBook/">NYSE FTP</a>.</p>

<blockquote>
  <p>TAQ (Trades and Quotes) historical data products provide a varying range of market depth on a T+1 basis for covered markets.
TAQ data products are used to develop and backtest trading strategies, analyze market trends as seen in a real-time ticker plant environment, and research markets for regulatory or audit activity.</p>
</blockquote>

<h3 id="prepare-training-data">Prepare Training Data</h3>

<p><code>OrderBook</code> is two sorted maps, where key is price and value is volume.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">case</span> <span class="type">class</span> <span class="class">OrderBook</span>(<span class="key">symbol</span>: <span class="predefined-type">String</span>,
                     <span class="key">buy</span>: <span class="predefined-type">TreeMap</span>[Int, Int] = <span class="predefined-type">TreeMap</span>.empty,
                     <span class="key">sell</span>: <span class="predefined-type">TreeMap</span>[Int, Int] = <span class="predefined-type">TreeMap</span>.empty)
</pre></div>
</div>
 </figure></notextile></div>

<h4 id="feature-sets">Feature Sets</h4>

<p>I’m using <code>Cell</code> from <a href="https://github.com/pellucidanalytics/framian">Framian</a> library to represent extracted feature values. It can be <code>Value</code>, <code>NA</code> or <code>NM</code>.</p>

<p>As defined in original paper we have three feature sets, first two calculated from <code>OrderBook</code>, last one requires <code>OrdersTrail</code> which effectively is
window computation over raw order log.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
sealed trait <span class="predefined-type">BasicAttribute</span>[T] <span class="directive">extends</span> <span class="predefined-type">Serializable</span> { self =&gt;
  <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">orderBook</span>: OrderBook): Cell[T]

  <span class="keyword">def</span> map[T2](<span class="key">f</span>: T =&gt; T2): <span class="predefined-type">BasicAttribute</span>[T2] = <span class="keyword">new</span> <span class="predefined-type">BasicAttribute</span>[T2] {
    <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">orderBook</span>: OrderBook): Cell[T2] = self(orderBook).map(f)
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
sealed trait TimeInsensitiveAttribute[T] <span class="directive">extends</span> <span class="predefined-type">Serializable</span> { self =&gt;
  <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">orderBook</span>: OrderBook): Cell[T]

  <span class="keyword">def</span> map[T2](<span class="key">f</span>: T =&gt; T2): TimeInsensitiveAttribute[T2] = <span class="keyword">new</span> TimeInsensitiveAttribute[T2] {
    <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">orderBook</span>: OrderBook): Cell[T2] = self(orderBook).map(f)
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
trait TimeSensitiveAttribute[T] <span class="directive">extends</span> <span class="predefined-type">Serializable</span> { self =&gt;
  <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">ordersTrail</span>: <span class="predefined-type">Vector</span>[OpenBookMsg]): Cell[T]

  <span class="keyword">def</span> map[T2](<span class="key">f</span>: T =&gt; T2): TimeSensitiveAttribute[T2] = <span class="keyword">new</span> TimeSensitiveAttribute[T2] {
    <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">ordersTrail</span>: <span class="predefined-type">Vector</span>[OpenBookMsg]): Cell[T2] = self(ordersTrail).map(f)
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<p>and it’s how features calculation looks like</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">BasicSet</span> <span class="directive">private</span>[attribute] (val <span class="key">config</span>: BasicSet.Config) <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {
  <span class="directive">private</span>[attribute] <span class="keyword">def</span> <span class="function">askPrice</span>(<span class="key">orderBook</span>: OrderBook)(<span class="key">i</span>: Int): Cell[Int] = {
    Cell.fromOption {
      orderBook.sell.keySet.drop(i - <span class="integer">1</span>).headOption
    }
  }

  <span class="directive">private</span>[attribute] <span class="keyword">def</span> <span class="function">bidPrice</span>(<span class="key">orderBook</span>: OrderBook)(<span class="key">i</span>: Int): Cell[Int] = {
    Cell.fromOption {
      val bidPrices = orderBook.buy.keySet
      <span class="keyword">if</span> (bidPrices.size &gt;= i) {
        bidPrices.drop(bidPrices.size - i).headOption
      } <span class="keyword">else</span> None
    }
  }

  <span class="directive">private</span> <span class="keyword">def</span> attribute[T](<span class="key">f</span>: OrderBook =&gt; Cell[T]): <span class="predefined-type">BasicAttribute</span>[T] = <span class="keyword">new</span> <span class="predefined-type">BasicAttribute</span>[T] {
    <span class="keyword">def</span> <span class="function">apply</span>(<span class="key">orderBook</span>: OrderBook): Cell[T] = f(orderBook)
  }

  <span class="keyword">def</span> <span class="function">askPrice</span>(<span class="key">i</span>: Int): <span class="predefined-type">BasicAttribute</span>[Int] = attribute(askPrice(_)(i))

  <span class="keyword">def</span> <span class="function">bidPrice</span>(<span class="key">i</span>: Int): <span class="predefined-type">BasicAttribute</span>[Int] = attribute(bidPrice(_)(i))

 val <span class="key">meanPrice</span>: <span class="predefined-type">BasicAttribute</span>[<span class="predefined-type">Double</span>] = {
    val ask1 = askPrice(<span class="integer">1</span>)
    val bid1 = bidPrice(<span class="integer">1</span>)
    <span class="predefined-type">BasicAttribute</span>.from(orderBook =&gt;
      ask1(orderBook).zipMap(bid1(orderBook)) {
        (ask, bid) =&gt; (ask.toDouble + bid.toDouble) / <span class="integer">2</span>
      })
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<h4 id="label-training-data">Label Training Data</h4>

<p>To extract labeled data from orders I’m using <code>LabeledPointsExtractor</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">LabeledPointsExtractor</span>[<span class="key">L</span>: LabelEncode] {

  <span class="keyword">def</span> <span class="function">labeledPoints</span>(<span class="key">orders</span>: <span class="predefined-type">Vector</span>[OpenBookMsg]): <span class="predefined-type">Vector</span>[LabeledPoint] = {
    log.debug(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Extract labeled points from orders log. Log size: </span><span class="inline"><span class="inline-delimiter">${</span>orders.size<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)

    <span class="comment">// ...</span>
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<p>and it can be constructed nicely with builder</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
val extractor = {
    <span class="keyword">import</span> <span class="include">com.scalafi.dynamics.attribute.LabeledPointsExtractor._</span>
    (LabeledPointsExtractor.newBuilder()
      += basic(_.askPrice(<span class="integer">1</span>))
      += basic(_.bidPrice(<span class="integer">1</span>))
      += basic(_.meanPrice)
      ).result(symbol, MeanPriceMovementLabel, LabeledPointsExtractor.Config(<span class="integer">1</span>.millisecond))
  }
</pre></div>
</div>
 </figure></notextile></div>

<p>This <code>extractor</code> will prepare labeled points using <code>MeanPriceMovementLabel</code> with 3 features: ask price, bid price and mean price</p>

<h3 id="run-classification-model">Run Classification Model</h3>

<p>In “real” application I’m using 36 features from all 3 feature sets. I run my tests with sample data from NYSE ftp,
<code>EQY_US_NYSE_BOOK_20130403</code> for model training and <code>EQY_US_NYSE_BOOK_20130404</code> for model validation.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
object DecisionTreeDynamics <span class="directive">extends</span> App with ConfiguredSparkContext with FeaturesExtractor {
  <span class="directive">private</span> val log = LoggerFactory.getLogger(<span class="local-variable">this</span>.getClass)

  <span class="keyword">case</span> <span class="type">class</span> <span class="class">Config</span>(<span class="key">training</span>: <span class="predefined-type">String</span> = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
                    <span class="key">validation</span>: <span class="predefined-type">String</span> = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
                    <span class="key">filter</span>: <span class="predefined-type">Option</span>[<span class="predefined-type">String</span>] = None,
                    <span class="key">symbol</span>: <span class="predefined-type">Option</span>[<span class="predefined-type">String</span>] = None)

  val parser = <span class="keyword">new</span> OptionParser[Config](<span class="string"><span class="delimiter">&quot;</span><span class="content">Order Book Dynamics</span><span class="delimiter">&quot;</span></span>) {
    <span class="comment">// ....</span>
  }

  parser.parse(args, Config()) map { implicit config =&gt;
    val trainingFiles = openBookFiles(<span class="string"><span class="delimiter">&quot;</span><span class="content">Training</span><span class="delimiter">&quot;</span></span>, config.training, config.filter)
    val validationFiles = openBookFiles(<span class="string"><span class="delimiter">&quot;</span><span class="content">Validation</span><span class="delimiter">&quot;</span></span>, config.validation, config.filter)

    val trainingOrderLog = orderLog(trainingFiles)
    log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Training order log size: </span><span class="inline"><span class="inline-delimiter">${</span>trainingOrderLog.count()<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)

    <span class="comment">// Configure DecisionTree model</span>
    val labelEncode = implicitly[LabelEncode[MeanPriceMove]]
    val numClasses = labelEncode.numClasses
    val categoricalFeaturesInfo = <span class="predefined-type">Map</span>.empty[Int, Int]
    val impurity = <span class="string"><span class="delimiter">&quot;</span><span class="content">gini</span><span class="delimiter">&quot;</span></span>
    val maxDepth = <span class="integer">5</span>
    val maxBins = <span class="integer">100</span>

    val trainingData = trainingOrderLog.extractLabeledData(featuresExtractor(<span class="key">_</span>: <span class="predefined-type">String</span>))
    val trainedModels = (trainingData map { <span class="keyword">case</span> LabeledOrderLog(symbol, labeledPoints) =&gt;
      log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>symbol</span><span class="content">: Train Decision Tree model. Training data size: </span><span class="inline"><span class="inline-delimiter">${</span>labeledPoints.count()<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)
      val model = DecisionTree.trainClassifier(labeledPoints, numClasses, categoricalFeaturesInfo, impurity, maxDepth, maxBins)
      val labelCounts = labeledPoints.map(_.label).countByValue().map {
        <span class="keyword">case</span> (key, count) =&gt; (labelEncode.decode(key.toInt), count)
      }
      log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>symbol</span><span class="content">: Label counts: [</span><span class="inline"><span class="inline-delimiter">${</span>labelCounts.mkString(<span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span>)<span class="inline-delimiter">}</span></span><span class="content">]</span><span class="delimiter">&quot;</span></span>)
      symbol -&gt; model
    }).toMap

    val validationOrderLog = orderLog(validationFiles)
    log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Validation order log size: </span><span class="inline"><span class="inline-delimiter">${</span>validationOrderLog.count()<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)
    val validationData = validationOrderLog.extractLabeledData(featuresExtractor(<span class="key">_</span>: <span class="predefined-type">String</span>))

    <span class="comment">// Evaluate model on validation data and compute training error</span>
    validationData.map { <span class="keyword">case</span> LabeledOrderLog(symbol, labeledPoints) =&gt;

      val model = trainedModels(symbol)

      log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>symbol</span><span class="content">: Evaluate model on validation data. Validation data size: </span><span class="inline"><span class="inline-delimiter">${</span>labeledPoints.count()<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)
      log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>symbol</span><span class="content">: Learned classification tree model: </span><span class="inline"><span class="inline-delimiter">$</span>model</span><span class="delimiter">&quot;</span></span>)

      val labelAndPrediction = labeledPoints.map { point =&gt;
        val prediction = model.predict(point.features)
        (point.label, prediction)
      }
      val trainingError = labelAndPrediction.filter(r =&gt; r._1 != r._2).count().toDouble / labeledPoints.count
      log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>symbol</span><span class="content">: Training Error = </span><span class="delimiter">&quot;</span></span> + trainingError)
    }
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<h4 id="training-error">Training Error</h4>

<p>Output of running Decision Tree classification for single symbol <code>ORCL</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
ORCL: Train Decision Tree model. Training data size: 64064
ORCL: Trained model in 3740 millis
ORCL: Label counts: [Stationary -&gt; 42137, Down -&gt; 10714, Up -&gt; 11213]
ORCL: Evaluate model on validation data. Validation data size: 54749
ORCL: Training Error = 0.28603262160039455
</pre></div>
</div>
 </figure></notextile></div>

<p>As you can see this pretty simple model was able to successfully classify ~70% of the data.</p>

<p><strong>Remark:</strong> Despite the fact, that this model shows very good success rate, it doesn’t mean that it
can be successfully used to build profitable automated trading strategy. First of all I don’t check
if it’s 95% success predicting stationary and 95% error rate predicting any price movement with
average 70% success rate. It doesn’t measure “strength” of price movement, it has to be sufficient to cover
transaction costs. And many other details that matters for building real trading system.</p>

<p>For sure it’s huge room for improvement and result validation. Unfortunately it’s hard do get enough data,
2 trading days is to small data set to draw conclusions and start building system to earn all the money in the world.
However I think it’ a good starting point.</p>

<h3 id="results">Results</h3>

<p>I was able to relatively easy reproduce fairly complicated research project at much lager scale than in original paper.</p>

<p>Latest Big Data technologies allows to build models using all available data, and stop doing samplings.
Using all of the data helps to build best possible models and capture all details from full data set.</p>

<blockquote>
  <p>The code for this application app can be found on <a href="https://github.com/ezhulenev/orderbook-dynamics">Github</a></p>
</blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Running Spark Tests in Standalone Cluster]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/10/18/run-tests-in-standalone-spark-cluster/"/>
    <updated>2014-10-18T21:01:15-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/10/18/run-tests-in-standalone-spark-cluster</id>
    <content type="html"><![CDATA[<p>Unit testing Spark Applications with standalone Apache Spark Cluster.</p>

<blockquote>
  <p><strong>Update 2015-10-08</strong>: Albeit approach described in this post works and totally valid, now I would suggest to take a look on packaging all tests in a fat jar
together with <code>scalatest</code> (or any other test library of your choice) and using <code>spark-submit</code> command to run it</p>
</blockquote>

<blockquote>
  <p>The code for this application app can be found on <a href="https://github.com/ezhulenev/spark-testing">Github</a></p>
</blockquote>

<h3 id="running-spark-applications">Running Spark Applications</h3>

<p>To be able to run Spark jobs, Spark cluster needs to have all classes used by your application in it’s classpath.
You can put manually all jar files required by your application to Spark nodes, but it’s not cool.
Another solution is to manually set jar files that required to distribute to worker nodes
when you create SparkConf. One way to do it, is to package your application as a “fat-jar”,
so you need to distribute only single jar.
Industry standard for packaging Spark application is <a href="https://github.com/sbt/sbt-assembly">sbt-assembly</a> plugin,
and it’s used by Spark itself.</p>

<h3 id="unit-testing-spark-applications">Unit Testing Spark Applications</h3>

<p>If you need to test your Spark application, easiest way is to create local Spark Context for each test, or maybe shared between all tests.
When Spark is running in local mode, it’s running in the same JVM as your tests with same jar files in classpath.</p>

<p>If your tests requires data that doesn’t fit into single node, for example in integration or acceptance tests,
obvious solution is to run them in standalone Spark cluster
with sufficient number of nodes. At this time everything becomes more difficult. Now you need to package you application with tests
in single jar file, and submit it to Spark cluster with each test.</p>

<!-- more -->

<h3 id="example-application">Example Application</h3>

<p>To show how to run and test Spark applications I prepared very <a href="https://github.com/ezhulenev/spark-testing">simple application</a>.
It uses <a href="https://github.com/ezhulenev/scala-openbook">Scala OpenBook</a>
library to parse <a href="http://www.nyxdata.com/Data-Products/NYSE-OpenBook-History">NYSE OpenBook</a> messages (orders log from New York Stock Exchange),
distribute them to cluster as RDD, and count Buy and Sell orders by ticker.
Only purpose of this application is to have dependency on a library that for sure is not available on Spark nodes.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="type">class</span> <span class="class">OrdersFunctions</span>(<span class="annotation">@transient</span> <span class="key">sc</span>: SparkContext, <span class="key">orders</span>: <span class="predefined-type">Iterator</span>[OpenBookMsg]) <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {

  <span class="directive">private</span> val ordersRDD = sc.parallelize(orders.toSeq)

  <span class="keyword">def</span> <span class="function">countBuyOrders</span>(): <span class="predefined-type">Map</span>[<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>] = countOrders(OrderFunctions.isBuySide)

  <span class="keyword">def</span> <span class="function">countSellOrders</span>(): <span class="predefined-type">Map</span>[<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>] = countOrders(OrderFunctions.isSellSide)

  <span class="directive">private</span> <span class="keyword">def</span> <span class="function">countOrders</span>(<span class="key">filter</span>: OpenBookMsg =&gt; <span class="predefined-type">Boolean</span>): <span class="predefined-type">Map</span>[<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>] =
    ordersRDD.filter(filter).
      map(order =&gt; (order.symbol, order)).
      countByKey().toMap

}
</pre></div>
</div>
 </figure></notextile></div>

<p> </p>

<h3 id="assembly-main-application">Assembly Main Application</h3>

<p>Add sbt-assembly plugin in project/plugin.sbt</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
addSbtPlugin(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.eed3si9n</span><span class="delimiter">&quot;</span></span> % <span class="string"><span class="delimiter">&quot;</span><span class="content">sbt-assembly</span><span class="delimiter">&quot;</span></span> % <span class="string"><span class="delimiter">&quot;</span><span class="content">0.11.2</span><span class="delimiter">&quot;</span></span>)
</pre></div>
</div>
 </figure></notextile></div>

<p>Add assembly settings to build.sbt</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">// Merge strategy shared between app &amp; test</span>

val <span class="key">sharedMergeStrategy</span>: (<span class="predefined-type">String</span> =&gt; MergeStrategy) =&gt; <span class="predefined-type">String</span> =&gt; MergeStrategy =
  old =&gt; {
    <span class="keyword">case</span> x <span class="keyword">if</span> x.startsWith(<span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/ECLIPSEF.RSA</span><span class="delimiter">&quot;</span></span>) =&gt; MergeStrategy.last
    <span class="keyword">case</span> x <span class="keyword">if</span> x.startsWith(<span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/mailcap</span><span class="delimiter">&quot;</span></span>) =&gt; MergeStrategy.last
    <span class="keyword">case</span> x <span class="keyword">if</span> x.endsWith(<span class="string"><span class="delimiter">&quot;</span><span class="content">plugin.properties</span><span class="delimiter">&quot;</span></span>) =&gt; MergeStrategy.last
    <span class="keyword">case</span> x =&gt; old(x)
  }

<span class="comment">// Load Assembly Settings</span>

assemblySettings

<span class="comment">// Assembly App</span>

mainClass <span class="keyword">in</span> assembly := Some(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.github.ezhulenev.spark.RunSparkApp</span><span class="delimiter">&quot;</span></span>)

jarName <span class="keyword">in</span> assembly := <span class="string"><span class="delimiter">&quot;</span><span class="content">spark-testing-example-app.jar</span><span class="delimiter">&quot;</span></span>

mergeStrategy <span class="keyword">in</span> assembly &lt;&lt;= (mergeStrategy <span class="keyword">in</span> assembly)(sharedMergeStrategy)
</pre></div>
</div>
 </figure></notextile></div>

<p>Inside your application you need to create SparkConf and add current jar to it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
  <span class="keyword">new</span> SparkConf().
      setMaster(<span class="string"><span class="delimiter">&quot;</span><span class="content">spark://spark-host:7777</span><span class="delimiter">&quot;</span></span>).
      setJars(SparkContext.jarOfClass(<span class="local-variable">this</span>.getClass).toSeq).
      setAppName(<span class="string"><span class="delimiter">&quot;</span><span class="content">SparkTestingExample</span><span class="delimiter">&quot;</span></span>)
</pre></div>
</div>
 </figure></notextile></div>

<p>After that you can use assembly command, and run assembled application in your Spark Cluster</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
&gt; sbt assembly
&gt; java -Dspark.master=spark://spark-host:7777 target/scala_2.10/spark-testing-example-app.jar
</pre></div>
</div>
 </figure></notextile></div>

<p> </p>

<h3 id="assembly-tests">Assembly Tests</h3>

<p>First step to run tests in standalone Spark Cluster is to package all main and test classes into single jar, that will be
transfered to each worker node before running tests. It’s very similar to assemblying main app.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">// Assembly Tests</span>

Project.inConfig(Test)(assemblySettings)

jarName <span class="keyword">in</span> (Test, assembly) := <span class="string"><span class="delimiter">&quot;</span><span class="content">spark-testing-example-tests.jar</span><span class="delimiter">&quot;</span></span>

mergeStrategy <span class="keyword">in</span> (Test, assembly) &lt;&lt;= (mergeStrategy <span class="keyword">in</span> assembly)(sharedMergeStrategy)

test <span class="keyword">in</span> (Test, assembly) := {} <span class="comment">// disable tests in assembly</span>
</pre></div>
</div>
 </figure></notextile></div>

<p>I wrote simple sbt plugin that has <code>test-assembly</code> task. First this task assemblies jar
file with test classes and all dependencies, then set it’s location
to environment variable, and then starts tests.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
object TestWithSparkPlugin <span class="directive">extends</span> sbt.Plugin {

  <span class="keyword">import</span> <span class="include">TestWithSparkKeys._</span>
  <span class="keyword">import</span> <span class="include">AssemblyKeys._</span>

  object TestWithSparkKeys {
    lazy val testAssembled        = TaskKey[Unit](<span class="string"><span class="delimiter">&quot;</span><span class="content">test-assembled</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Run tests with standalone Spark cluster</span><span class="delimiter">&quot;</span></span>)
    lazy val assembledTestsProp   = SettingKey[<span class="predefined-type">String</span>](<span class="string"><span class="delimiter">&quot;</span><span class="content">assembled-tests-prop</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Environment variable name used to pass assembled jar name to test</span><span class="delimiter">&quot;</span></span>)
  }

  lazy val <span class="key">baseTestWithSparkSettings</span>: Seq[sbt.Def.Setting[_]] = Seq(
    testAssembled        := TestWithSpark.testWithSparkTask.value,
    assembledTestsProp   := <span class="string"><span class="delimiter">&quot;</span><span class="content">ASSEMBLED_TESTS</span><span class="delimiter">&quot;</span></span>
  )

  lazy val <span class="key">testWithSparkSettings</span>: Seq[sbt.Def.Setting[_]] = baseTestWithSparkSettings

  object TestWithSpark {

    <span class="keyword">def</span> <span class="key">assemblyTestsJarTask</span>: Initialize[Task[<span class="predefined-type">File</span>]] = Def.task {
      val assembled = (assembly <span class="keyword">in</span> Test).value
      sys.props(assembledTestsProp.value) = assembled.getAbsolutePath
      assembled
    }

    <span class="directive">private</span> <span class="keyword">def</span> runTests = Def.task {
      (test <span class="keyword">in</span> Test).value
    }

    <span class="keyword">def</span> <span class="key">testWithSparkTask</span>: Initialize[Task[Unit]] = Def.sequentialTask {
      assemblyTestsJarTask.value
      runTests.value
    }
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<p>All Apache Spark tests should inherit <code>ConfiguredSparkFlatSpec</code> with configured Spark Context. If assembled tests jar file
is available, it’s distributed to Spark worker nodes. If not, only local mode is supported.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
trait ConfiguredSparkFlatSpec <span class="directive">extends</span> FlatSpec with BeforeAndAfterAll {
  <span class="directive">private</span> val log = LoggerFactory.getLogger(classOf[ConfiguredSparkFlatSpec])

  <span class="directive">private</span> val config = ConfigFactory.load()

  <span class="directive">private</span> lazy val sparkConf = {
    val master = config.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">spark.master</span><span class="delimiter">&quot;</span></span>)

    log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Create spark context. Master: </span><span class="inline"><span class="inline-delimiter">$</span>master</span><span class="delimiter">&quot;</span></span>)
    val assembledTests = sys.props.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ASSEMBLED_TESTS</span><span class="delimiter">&quot;</span></span>)

    val baseConf = <span class="keyword">new</span> SparkConf().
      setMaster(master).
      setAppName(<span class="string"><span class="delimiter">&quot;</span><span class="content">SparkTestingExample</span><span class="delimiter">&quot;</span></span>)

    assembledTests match {
      <span class="keyword">case</span> None =&gt;
        log.warn(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Assembled tests jar not found. Standalone Spark mode is not supported</span><span class="delimiter">&quot;</span></span>)
        baseConf
      <span class="keyword">case</span> Some(path) =&gt;
        log.info(s<span class="string"><span class="delimiter">&quot;</span><span class="content">Add assembled tests to Spark Context from: </span><span class="inline"><span class="inline-delimiter">$</span>path</span><span class="delimiter">&quot;</span></span>)
        baseConf.setJars(path :: Nil)
    }
  }

  lazy val sc = <span class="keyword">new</span> SparkContext(sparkConf)

  override <span class="directive">protected</span> <span class="keyword">def</span> <span class="function">afterAll</span>(): Unit = {
    <span class="local-variable">super</span>.afterAll()
    sc.stop()
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<p> </p>

<h3 id="running-tests">Running Tests</h3>

<p>By default <code>spark.master</code> property is set to local[2]. So you can run tests in local mode. If you want run tests
in standalone Apache Spark, you need to override <code>spark.master</code> with your master node.</p>

<p>If you’ll try to run <code>test</code> command with standalone cluster it will fail with ClassNotFoundException</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
&gt; sbt -Dspark.master=spark://spark-host:7777 test
&gt;
&gt; Create spark context. Master: spark://Eugenes-MacBook-Pro.local:7077
&gt; Assembled tests jar not found. Standalone Spark mode is not supported
&gt;
&gt; [error] Failed tests:
&gt; org.apache.spark.SparkException: Job aborted due to stage failure:
&gt; Task 2 in stage 1.0 failed 4 times, most recent failure:
&gt; Lost task 2.3 in stage 1.0 (TID 30, 192.168.0.11):
&gt; java.lang.ClassNotFoundException: com.scalafi.openbook.OpenBookMsg
</pre></div>
</div>
 </figure></notextile></div>

<p>However <code>test-assembled</code> will be successfull</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
&gt; sbt -Dspark.master=spark://spark-host:7777 test-assembled
&gt;
&gt; Create spark context. Master: spark://Eugenes-MacBook-Pro.local:7077
&gt; Add assembled tests to Spark Context from: /Users/ezhulenev/spark-testing/target/scala-2.10/spark-testing-example-tests.jar
&gt;
&gt; [info] Run completed in 7 seconds, 587 milliseconds.
&gt; [info] Total number of tests run: 2
&gt; [info] Suites: completed 1, aborted 0
&gt; [info] Tests: succeeded 2, failed 0, canceled 0, ignored 0, pending 0
&gt; [info] All tests passed.
&gt; [success] Total time: 37 s
</pre></div>
</div>
 </figure></notextile></div>

<p> </p>

<blockquote>
  <p>The code for this application app can be found on <a href="https://github.com/ezhulenev/spark-testing">Github</a></p>
</blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Akka Cluster for Value at Risk Calculation (Part 2/2)]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-2/"/>
    <updated>2014-05-01T22:03:45-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-2</id>
    <content type="html"><![CDATA[<h3 id="synopsis">Synopsis</h3>

<blockquote>
  <p>The code &amp; sample app can be found on <a href="https://github.com/ezhulenev/akka-var-calculation">Github</a></p>
</blockquote>

<p>Risk Management in finance is one of the most common <a href="http://www.gridgain.com/usecases/risk-management/">case studies</a>
for Grid Computing, and Value-at-Risk is most widely used risk measure.
In this article I’m going to show how to <code>scale-out</code> Value-at-Risk calculation to multiple nodes with latest <a href="http://akka.io">Akka</a> middleware.
In Part 1 I’m describing the problem and <code>single-node</code> solution, and in Part 2 I’m scaling it to multiple nodes.</p>

<h2 id="part-22-scale-out-var-calculation-to-multiple-nodes">[Part 2/2] Scale-out VaR calculation to multiple nodes</h2>

<p>Go to <a href="http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-1">Part 1</a> where Value at Risk calculator defined.</p>

<!-- more -->

<h3 id="akka-cluster">Akka Cluster</h3>

<p>Akka is amazing library for Actors abstraction for Scala and Java.</p>

<blockquote>
  <p>Actors are location transparent and distributable by design. This means that you can write your application without hardcoding how it will be deployed and distributed, and then later just configure your actor system against a certain topology <a href="http://doc.akka.io/docs/akka/snapshot/general/remoting.html">…</a></p>
</blockquote>

<p>Akka Cluster provides a fault-tolerant decentralized peer-to-peer based cluster membership service with no single point of failure or single point of bottleneck. It does this using gossip protocols and an automatic failure detector.</p>

<p>It means that it’s very easy to distribute portfolio simulations to multiple nodes.</p>

<h3 id="messages">Messages</h3>

<p>Messages that are passed around between backend &amp; calculator nodes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">messages</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">WakeUp</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">RegisterBackend</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">RunSimulation</span><span class="o">(</span><span class="n">positions</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Position</span><span class="o">],</span>
</span><span class="line">                           <span class="n">simulations</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
</span><span class="line">                           <span class="n">generator</span><span class="k">:</span> <span class="kt">MarketFactorsGenerator</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SimulationResponse</span><span class="o">(</span><span class="n">v</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="simulation-backend-node">Simulation Backend Node</h3>

<p>First type of node in a cluster is SimulationNode that is going to run all ‘heavy’ portfolio price simulations.</p>

<p>After joining the cluster it subscribes for all <code>MemberUp</code> messages, and when new node with role <code>calculator</code> joins the cluster, it register itself as available backend.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">PortfolioValueSimulationBackend</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="k">with</span> <span class="nc">ActorLogging</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span> <span class="k">val</span> <span class="n">cluster</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">preStart</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">MemberUp</span><span class="o">])</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">postStop</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">unsubscribe</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="nc">RunSimulation</span><span class="o">(</span><span class="n">portfolio</span><span class="o">,</span> <span class="n">simulations</span><span class="o">,</span> <span class="n">generator</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class="line">      <span class="n">runSimulation</span><span class="o">(</span>
</span><span class="line">        <span class="nc">Portfolio</span><span class="o">(</span><span class="n">nel</span><span class="o">(</span><span class="n">portfolio</span><span class="o">.</span><span class="n">head</span><span class="o">,</span> <span class="n">portfolio</span><span class="o">.</span><span class="n">tail</span><span class="o">)),</span>
</span><span class="line">        <span class="n">simulations</span><span class="o">,</span> <span class="n">generator</span>
</span><span class="line">      <span class="o">)</span> <span class="n">pipeTo</span> <span class="n">sender</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">case</span> <span class="n">state</span><span class="k">:</span> <span class="kt">CurrentClusterState</span> <span class="o">=&gt;</span>
</span><span class="line">      <span class="n">state</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="nc">MemberStatus</span><span class="o">.</span><span class="nc">Up</span><span class="o">)</span> <span class="n">foreach</span> <span class="n">register</span>
</span><span class="line">
</span><span class="line">    <span class="k">case</span> <span class="nc">MemberUp</span><span class="o">(</span><span class="n">member</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class="line">      <span class="n">register</span><span class="o">(</span><span class="n">member</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span> <span class="k">def</span> <span class="n">register</span><span class="o">(</span><span class="n">member</span><span class="k">:</span> <span class="kt">Member</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="n">hasRole</span><span class="o">(</span><span class="s">&quot;calculator&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">memberRoot</span> <span class="k">=</span> <span class="nc">RootActorPath</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="n">address</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">backendManager</span> <span class="k">=</span>
</span><span class="line">        <span class="n">context</span><span class="o">.</span><span class="n">actorSelection</span><span class="o">(</span><span class="n">memberRoot</span> <span class="o">/</span> <span class="s">&quot;user&quot;</span> <span class="o">/</span> <span class="s">&quot;backendManager&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="n">backendManager</span> <span class="o">!</span> <span class="nc">RegisterBackend</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span> <span class="k">def</span> <span class="n">runSimulation</span><span class="o">(</span><span class="n">portfolio</span><span class="k">:</span> <span class="kt">Portfolio</span><span class="o">,</span>
</span><span class="line">        <span class="n">simulations</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
</span><span class="line">        <span class="n">generator</span><span class="k">:</span> <span class="kt">MarketFactorsGenerator</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">SimulationResponse</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">process</span> <span class="k">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="n">simulations</span><span class="o">).</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">      <span class="k">implicit</span> <span class="n">factors</span> <span class="k">=&gt;</span>
</span><span class="line">        <span class="nc">PortfolioPricer</span><span class="o">.</span><span class="n">price</span><span class="o">(</span><span class="n">portfolio</span><span class="o">).</span>
</span><span class="line">            <span class="n">fold</span><span class="o">(</span><span class="n">err</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Failure: $err&quot;</span><span class="o">),</span> <span class="n">identity</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">task</span> <span class="k">=</span> <span class="nc">Task</span><span class="o">.</span><span class="n">fork</span> <span class="o">{</span>
</span><span class="line">      <span class="n">process</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">portfolioValues</span> <span class="k">=&gt;</span> <span class="n">portfolioValues</span><span class="o">.</span><span class="n">toVector</span><span class="o">)</span>
</span><span class="line">    <span class="o">}(</span><span class="n">executor</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="nc">Promise</span><span class="o">[</span><span class="kt">SimulationResponse</span><span class="o">]()</span>
</span><span class="line">
</span><span class="line">    <span class="n">task</span><span class="o">.</span><span class="n">runAsync</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="o">-\/(</span><span class="n">err</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">failure</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>
</span><span class="line">      <span class="k">case</span> <span class="o">\/-(</span><span class="n">result</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">success</span><span class="o">(</span><span class="nc">SimulationResponse</span><span class="o">(</span><span class="n">result</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="n">p</span><span class="o">.</span><span class="n">future</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="calculator-node">Calculator Node</h3>

<p>Calculator node joins the cluster, and receive <code>RegisterBackend</code> messages from simulation nodes. It keeps track of all available simulation backend nodes, and when gets a request to calculate market risk,
it splits this request into multiple simulation tasks and send them to all available simulation backends.</p>

<h5 id="backend-nodes-manager">Backend Nodes Manager</h5>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">BackendNodesManager</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="k">with</span> <span class="nc">ActorLogging</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="n">backendNodes</span> <span class="k">=</span> <span class="nc">ListBuffer</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">]</span>
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">var</span> <span class="n">jobCounter</span> <span class="k">=</span> <span class="mi">0</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Timeout</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">receive</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="nc">WakeUp</span> <span class="k">=&gt;</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Wake up backend nodes manager&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">case</span> <span class="n">run</span><span class="k">:</span> <span class="kt">RunSimulation</span> <span class="o">=&gt;</span>
</span><span class="line">      <span class="n">jobCounter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">      <span class="k">val</span> <span class="n">backendN</span> <span class="k">=</span> <span class="n">jobCounter</span> <span class="o">%</span> <span class="n">backendNodes</span><span class="o">.</span><span class="n">size</span>
</span><span class="line">      <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Pass simulation request to backend: $backendN&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="n">backendNodes</span><span class="o">(</span><span class="n">backendN</span><span class="o">)</span> <span class="o">?</span> <span class="n">run</span> <span class="n">pipeTo</span> <span class="n">sender</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">case</span> <span class="nc">RegisterBackend</span> <span class="k">if</span> <span class="o">!</span><span class="n">backendNodes</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">sender</span><span class="o">())</span> <span class="k">=&gt;</span>
</span><span class="line">      <span class="n">context</span> <span class="n">watch</span> <span class="n">sender</span><span class="o">()</span>
</span><span class="line">      <span class="n">backendNodes</span> <span class="o">+=</span> <span class="n">sender</span><span class="o">()</span>
</span><span class="line">      <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Added new backend. &quot;</span><span class="o">+</span>
</span><span class="line">                <span class="n">s</span><span class="s">&quot;Total: ${backendNodes.size}. Node: [${sender()}}]&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">case</span> <span class="nc">Terminated</span><span class="o">(</span><span class="n">backEnd</span><span class="o">)</span> <span class="k">if</span> <span class="n">backendNodes</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">backEnd</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class="line">      <span class="n">backendNodes</span> <span class="o">-=</span> <span class="n">sender</span><span class="o">()</span>
</span><span class="line">      <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Removed terminated backend. &quot;</span><span class="o">+</span>
</span><span class="line">                <span class="n">s</span><span class="s">&quot;Total: ${backendNodes.size}. &quot;</span><span class="o">+</span>
</span><span class="line">                <span class="n">s</span><span class="s">&quot;Terminated node: [${sender()}}]&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h5 id="cluster-portfolio-value-simulation">Cluster Portfolio Value Simulation</h5>

<p>Simulation channel constructed by <code>asking</code> backend simulation actors to run simulation and converting <code>scala.concurrent.Future</code> to <code>scalaz.concurrent.Task</code>. Concurrency management and split factor is defined
in abstract monte carlo risk calculator described in <a href="http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-1">Part 1</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">ClusterPortfolioValueSimulation</span> <span class="k">extends</span> <span class="nc">PortfolioValueSimulation</span> <span class="o">{</span>
</span><span class="line">  <span class="n">self</span><span class="k">:</span> <span class="kt">MarketFactorsModule</span> <span class="kt">with</span> <span class="kt">MonteCarloMarketRiskCalculator</span> <span class="o">=&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">systemName</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">systemConfig</span><span class="k">:</span> <span class="kt">Config</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">lazy</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="n">systemName</span><span class="o">,</span> <span class="n">systemConfig</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">lazy</span> <span class="k">val</span> <span class="n">backendManager</span> <span class="k">=</span>
</span><span class="line">    <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">BackendNodesManager</span><span class="o">],</span> <span class="s">&quot;backendManager&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">simulation</span><span class="o">(</span><span class="n">portfolio</span><span class="k">:</span> <span class="kt">Portfolio</span><span class="o">,</span> <span class="n">simulations</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">    <span class="n">channel</span><span class="o">[</span><span class="kt">MarketFactorsGenerator</span>, <span class="kt">Simulations</span><span class="o">]</span> <span class="o">{</span> <span class="n">generator</span> <span class="k">=&gt;</span>
</span><span class="line">      <span class="nc">Task</span><span class="o">.</span><span class="n">async</span><span class="o">[</span><span class="kt">Simulations</span><span class="o">](</span><span class="n">cb</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">        <span class="o">(</span><span class="n">backendManager</span> <span class="o">?</span> <span class="nc">RunSimulation</span><span class="o">(...)).</span><span class="n">onComplete</span> <span class="o">{</span>
</span><span class="line">          <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>                   <span class="k">=&gt;</span> <span class="n">cb</span><span class="o">(-\/(</span><span class="n">err</span><span class="o">))</span>
</span><span class="line">          <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">SimulationResponse</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">cb</span><span class="o">(\/-(</span><span class="nc">Simulations</span><span class="o">(</span><span class="n">s</span><span class="o">)))</span>
</span><span class="line">          <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">u</span><span class="o">)</span>                     <span class="k">=&gt;</span>
</span><span class="line">            <span class="n">cb</span><span class="o">(-\/(</span><span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Unknown response: $u&quot;</span><span class="o">)))</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="o">})</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="run-calculation-in-cluster">Run Calculation in Cluster</h3>

<p>In this example I’m going to run all nodes in a single JVM for simplicity. Distributed deployment is only Akka configuration issue, and it doesn’t affect the code at all.</p>

<p>I’m starting three <code>simulation backend</code> nodes in a cluster, and later join them with <code>calculator</code> node, and submit risk calculation task.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">ClusterMarketRiskCalculation</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">SystemName</span> <span class="k">=</span> <span class="s">&quot;ClusterMarketRiskCalculation&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">simulationConfig</span> <span class="k">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="n">parseResources</span><span class="o">(</span><span class="s">&quot;simulation-node.conf&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">calculatorConfig</span> <span class="k">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="n">parseResources</span><span class="o">(</span><span class="s">&quot;calculator-node.conf&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Start 3 simulation nodes</span>
</span><span class="line">  <span class="k">val</span> <span class="n">system1</span>  <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="nc">SystemName</span><span class="o">,</span> <span class="n">simulationConfig</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">joinAddress</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">(</span><span class="n">system1</span><span class="o">).</span><span class="n">selfAddress</span>
</span><span class="line">  <span class="nc">Cluster</span><span class="o">(</span><span class="n">system1</span><span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="n">joinAddress</span><span class="o">)</span>
</span><span class="line">  <span class="n">system1</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">PortfolioValueSimulationBackend</span><span class="o">],</span> <span class="s">&quot;simulationBackend&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">system2</span>  <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="nc">SystemName</span><span class="o">,</span> <span class="n">simulationConfig</span><span class="o">)</span>
</span><span class="line">  <span class="nc">Cluster</span><span class="o">(</span><span class="n">system2</span><span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="n">joinAddress</span><span class="o">)</span>
</span><span class="line">  <span class="n">system2</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">PortfolioValueSimulationBackend</span><span class="o">],</span> <span class="s">&quot;simulationBackend&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">system3</span>  <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="nc">SystemName</span><span class="o">,</span> <span class="n">simulationConfig</span><span class="o">)</span>
</span><span class="line">  <span class="nc">Cluster</span><span class="o">(</span><span class="n">system3</span><span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="n">joinAddress</span><span class="o">)</span>
</span><span class="line">  <span class="n">system3</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">PortfolioValueSimulationBackend</span><span class="o">],</span> <span class="s">&quot;simulationBackend&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Start Cluster Risk Calculator node</span>
</span><span class="line">  <span class="k">object</span> <span class="nc">RiskCalculator</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">MonteCarloMarketRiskCalculator</span><span class="o">(</span><span class="mi">10000</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">    <span class="k">with</span> <span class="nc">ClusterPortfolioValueSimulation</span>
</span><span class="line">    <span class="k">with</span> <span class="nc">HistoricalMarketFactors</span> <span class="k">with</span> <span class="nc">HistoricalMarketData</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">systemName</span> <span class="k">=</span> <span class="nc">SystemName</span>
</span><span class="line">    <span class="k">val</span> <span class="n">systemConfig</span> <span class="k">=</span> <span class="n">calculatorConfig</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nc">RiskCalculator</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">joinAddress</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Let&#39;s cluster state some time to converge</span>
</span><span class="line">  <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Run VaR calculation</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">AMZN</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;AMZN&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">AAPL</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;AAPL&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">IBM</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;IBM&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">GS</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;GS&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Portfolio evaluation date</span>
</span><span class="line">  <span class="k">val</span> <span class="n">date</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LocalDate</span><span class="o">(</span><span class="mi">2014</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Options maturity date</span>
</span><span class="line">  <span class="k">val</span> <span class="n">maturityDate</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LocalDate</span><span class="o">(</span><span class="mi">2014</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">31</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">portfolio</span> <span class="k">=</span> <span class="nc">Portfolio</span><span class="o">(</span><span class="n">nels</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Position</span><span class="o">(</span><span class="nc">AMZN</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span>
</span><span class="line">    <span class="nc">Position</span><span class="o">(</span><span class="nc">AAPL</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span>
</span><span class="line">    <span class="nc">Position</span><span class="o">(</span><span class="nc">IBM</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span>
</span><span class="line">    <span class="nc">Position</span><span class="o">(</span><span class="nc">CallOption</span><span class="o">(</span><span class="nc">GS</span><span class="o">,</span> <span class="mi">180</span><span class="o">,</span> <span class="n">maturityDate</span><span class="o">),</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">  <span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">start</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()</span>
</span><span class="line">  <span class="k">val</span> <span class="n">marketRisk</span> <span class="k">=</span> <span class="nc">RiskCalculator</span><span class="o">.</span><span class="n">marketRisk</span><span class="o">(</span><span class="n">portfolio</span><span class="o">,</span> <span class="n">date</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">end</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">  <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Calculated marker risk in ${end - start} milliseconds; &quot;</span> <span class="o">+</span>
</span><span class="line">    <span class="n">s</span><span class="s">&quot;VaR(p = 0.95) = ${marketRisk.VaR(0.95)}, &quot;</span> <span class="o">+</span>
</span><span class="line">    <span class="n">s</span><span class="s">&quot;CVaR(p = 0.95) = ${marketRisk.conditionalVaR(0.95)}&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Shutdown actor systems</span>
</span><span class="line">  <span class="n">system1</span><span class="o">.</span><span class="n">shutdown</span><span class="o">()</span>
</span><span class="line">  <span class="n">system2</span><span class="o">.</span><span class="n">shutdown</span><span class="o">()</span>
</span><span class="line">  <span class="n">system3</span><span class="o">.</span><span class="n">shutdown</span><span class="o">()</span>
</span><span class="line">  <span class="nc">RiskCalculator</span><span class="o">.</span><span class="n">shutdown</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// and application</span>
</span><span class="line">  <span class="nc">System</span><span class="o">.</span><span class="n">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="conclusion">Conclusion</h3>

<p>As I showed in this post moving calculations to a cluster can be easy and fun task with Akka Cluster.</p>

<p>I use scalaz-stream for abstracting over <code>effectful functions</code> with <code>scalaz.stream.Channel</code>, I guess it maybe be overengineering in this particular case,
but it allows to completely hide implementation details and take control concurrency in very abstract way.
And scalaz-stream is very nice and super powerful library, I strongly encourage you to take a look on it.</p>

<h5 id="links">Links</h5>

<ol>
  <li>Akka http://akka.io/ and http://doc.akka.io/docs/akka/2.3.2/scala/index-network.html</li>
  <li>Scalaz-stream https://github.com/scalaz/scalaz-stream</li>
  <li>Value at Risk http://en.wikipedia.org/wiki/Value_at_risk</li>
</ol>

<h4 id="check-source-code-on-githubhttpsgithubcomezhulenevakka-var-calculation">Check source code on <a href="https://github.com/ezhulenev/akka-var-calculation">GitHub</a></h4>

<h2 id="go-to-part-1blog20140501akka-cluster-for-value-at-risk-calculation-1"><a href="http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-1">«&lt; Go to Part 1</a></h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Akka Cluster for Value at Risk Calculation (Part 1/2)]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-1/"/>
    <updated>2014-05-01T22:03:45-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-1</id>
    <content type="html"><![CDATA[<h3 id="synopsis">Synopsis</h3>

<blockquote>
  <p>The code &amp; sample app can be found on <a href="https://github.com/ezhulenev/akka-var-calculation">Github</a></p>
</blockquote>

<p>Risk Management in finance is one of the most common <a href="http://www.gridgain.com/usecases/risk-management/">case studies</a>
for Grid Computing, and Value-at-Risk is most widely used risk measure.
In this article I’m going to show how to <code>scale-out</code> Value-at-Risk calculation to multiple nodes with latest <a href="http://akka.io">Akka</a> middleware.
In Part 1 I’m describing the problem and <code>single-node</code> solution, and in Part 2 I’m scaling it to multiple nodes.</p>

<h2 id="part-1-introduction-to-value-at-risk-calculation">[Part 1] Introduction to Value at Risk calculation</h2>

<p>Go to <a href="http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-2">Part 2</a> where VaR calculation scaled-out to multiple nodes.</p>

<!-- more -->

<h3 id="what-is-value-at-risk">What is Value-at-Risk</h3>

<blockquote>
  <p>In financial mathematics and financial risk management, value at risk (VaR) is a widely used risk measure of the risk of loss on a specific portfolio of financial assets. For a given portfolio, probability and time horizon, VaR is defined as a threshold value such that the probability that the mark-to-market loss on the portfolio over the given time horizon exceeds this value (assuming normal markets and no trading in the portfolio) is the given probability level.</p>
</blockquote>

<p>You can continue with reading amazing set of articles <a href="http://blog.octo.com/en/introduction-to-grid-computing-for-value-at-risk-calculatio/">“Introduction to Grid Computing for Value At Risk calculation”</a> where VaR described in more details
and explained why it’s a perfect fit for grid computing and spreading calculation across multiple nodes. Also there you can find examples for <a href="http://www.gridgain.com/">GridGain</a> and <a href="http://hadoop.apache.org/">Hadoop</a>. In this article I’m going to use Akka.</p>

<h3 id="data-model">Data Model</h3>

<p>Let’s define simple model for supported instruments:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Instrument</span>
</span><span class="line">
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">Equity</span><span class="o">(</span><span class="n">ticker</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Instrument</span>
</span><span class="line">
</span><span class="line"><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">EquityOption</span> <span class="k">extends</span> <span class="nc">Instrument</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">underlying</span><span class="k">:</span> <span class="kt">Equity</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">CallOption</span><span class="o">(</span>
</span><span class="line">           <span class="n">underlying</span><span class="k">:</span> <span class="kt">Equity</span><span class="o">,</span>
</span><span class="line">           <span class="n">strike</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span>
</span><span class="line">           <span class="n">maturity</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EquityOption</span>
</span><span class="line">
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">PutOption</span><span class="o">(</span>
</span><span class="line">           <span class="n">underlying</span><span class="k">:</span> <span class="kt">Equity</span><span class="o">,</span>
</span><span class="line">           <span class="n">strike</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span>
</span><span class="line">           <span class="n">maturity</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EquityOption</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and portfolio for which market risk will be calculated:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"> <span class="k">case</span> <span class="k">class</span> <span class="nc">Position</span><span class="o">(</span><span class="n">instrument</span><span class="k">:</span> <span class="kt">Instrument</span><span class="o">,</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"> <span class="k">case</span> <span class="k">class</span> <span class="nc">Portfolio</span><span class="o">(</span><span class="n">positions</span><span class="k">:</span> <span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">Position</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="portfolio-pricing">Portfolio pricing</h3>

<p>Let’s define elementary portfolio pricing service, that can calculate market price for instrument based on market factors:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">MarketFactor</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">MarketFactor</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">Price</span><span class="o">(</span><span class="n">equity</span><span class="k">:</span> <span class="kt">Equity</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">MarketFactor</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">Volatility</span><span class="o">(</span><span class="n">equity</span><span class="k">:</span> <span class="kt">Equity</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">MarketFactor</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">DaysToMaturity</span><span class="o">(</span><span class="n">maturity</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">MarketFactor</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">RiskFreeRate</span> <span class="k">extends</span> <span class="nc">MarketFactor</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">MarketFactors</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">factor</span><span class="k">:</span> <span class="kt">MarketFactor</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">MarketFactorsGenerator</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">factors</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">MarketFactors</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">PricingError</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">PricingError</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">MissingMarketFactors</span><span class="o">(</span><span class="n">factors</span><span class="k">:</span> <span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">MarketFactor</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">PricingError</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="nd">@implicitNotFound</span><span class="o">(</span><span class="n">msg</span> <span class="k">=</span> <span class="s">&quot;Can&#39;t find pricer for instrument type &#39;${I}&#39;&quot;</span><span class="o">)</span>
</span><span class="line"><span class="k">trait</span> <span class="nc">Pricer</span><span class="o">[</span><span class="kt">I</span> <span class="k">&lt;:</span> <span class="kt">Instrument</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">price</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">I</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MarketFactors</span><span class="o">)</span><span class="k">:</span> <span class="kt">PricingError</span> <span class="kt">\/</span> <span class="kt">Double</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Pricer</span> <span class="k">extends</span> <span class="nc">PricerImplicits</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">PricerImplicits</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">implicit</span> <span class="k">object</span> <span class="nc">EquityPricer</span> <span class="k">extends</span> <span class="nc">Pricer</span><span class="o">[</span><span class="kt">Equity</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">        <span class="c1">// ...</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">implicit</span> <span class="k">object</span> <span class="nc">OptionPricer</span> <span class="k">extends</span> <span class="nc">Pricer</span><span class="o">[</span><span class="kt">EquityOption</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">        <span class="c1">// Use Black-Scholes formula to price Option</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="market-risk-calculator">Market Risk Calculator</h3>

<p>Portfolio Market Risk depends on market factors forecast. I’m going to construct market factors forecast for one day horizon from historical market data:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">MarketDataModule</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">def</span> <span class="n">marketData</span><span class="k">:</span> <span class="kt">MarketData</span>
</span><span class="line">
</span><span class="line">  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">MarketDataError</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">MarketDataUnavailable</span><span class="o">(</span><span class="n">error</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">MarketDataError</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">MarketData</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">historicalPrices</span><span class="o">(</span><span class="n">equity</span><span class="k">:</span> <span class="kt">Equity</span><span class="o">,</span> <span class="n">from</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span><span class="k">:</span>  <span class="kt">MarketDataError</span> <span class="kt">\/</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">HistoricalPrice</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">historicalPrice</span><span class="o">(</span><span class="n">equity</span><span class="k">:</span> <span class="kt">Equity</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span><span class="k">:</span> <span class="kt">MarketDataError</span> <span class="kt">\/</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">HistoricalPrice</span><span class="o">]</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">MarketFactorsModule</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">MarketFactorsParameters</span><span class="o">(</span><span class="n">riskFreeRate</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">,</span>
</span><span class="line">                                     <span class="n">horizon</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">def</span> <span class="n">oneDayMarketFactors</span><span class="o">(</span><span class="n">portfolio</span><span class="k">:</span> <span class="kt">Portfolio</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">parameters</span><span class="k">:</span> <span class="kt">MarketFactorsParameters</span><span class="o">)</span><span class="k">:</span> <span class="kt">MarketFactorsGenerator</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">def</span> <span class="n">marketFactors</span><span class="o">(</span><span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">parameters</span><span class="k">:</span> <span class="kt">MarketFactorsParameters</span><span class="o">)</span><span class="k">:</span> <span class="kt">MarketFactors</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">MarketRiskCalculator</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="kt">MarketRisk</span> <span class="k">&lt;:</span> <span class="kt">MarketRiskLike</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">MarketRiskLike</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="nc">VaR</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span>
</span><span class="line">    <span class="k">def</span> <span class="n">conditionalVaR</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">marketRisk</span><span class="o">(</span><span class="n">portfolio</span><span class="k">:</span> <span class="kt">Portfolio</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span><span class="k">:</span> <span class="kt">MarketRisk</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="monte-carlo-simulation-for-market-risk-calculation">Monte Carlo Simulation for Market Risk Calculation</h3>

<blockquote>
  <p>Monte Carlo simulation performs risk analysis by building models of possible results by substituting a range of values—a probability distribution—for any factor that has inherent uncertainty. It then calculates results over and over, each time using a different set of random values from the probability functions. Depending upon the number of uncertainties and the ranges specified for them, a Monte Carlo simulation could involve thousands or tens of thousands of recalculations before it is complete. Monte Carlo simulation produces distributions of possible outcome values. <a href="http://www.palisade.com/risk/monte_carlo_simulation.asp">…</a></p>
</blockquote>

<h4 id="abstract-monte-carlo-risk-calculator">Abstract Monte Carlo Risk Calculator</h4>

<p>I will use <a href="http://eugenezhulenev.com/blog/2014/03/09/2014-03-09-scalaz-stream-concurrent-process">scalaz-stream</a> for splitting calculation to independent tasks, running them <a href="http://eugenezhulenev.com/blog/2014/03/09/2014-03-09-scalaz-stream-concurrent-process">concurrently</a> and aggregating results.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Some code is omitted. Full source code on Github &#8211;&gt;&gt;&gt;</span><a href="https://github.com/ezhulenev/akka-var-calculation/blob/master/core/src/main/scala/kkalc/service/simulation/MonteCarloMarketRiskCalculator.scala">link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">PortfolioValueSimulation</span> <span class="o">{</span>
</span><span class="line">  <span class="n">self</span><span class="k">:</span> <span class="kt">MarketFactorsModule</span> <span class="kt">with</span> <span class="kt">MonteCarloMarketRiskCalculator</span> <span class="o">=&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Scalaz-Stream Channel that for given market factors generator</span>
</span><span class="line"><span class="cm">   * runs defined number of simulations and produce MarketRisk</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="k">def</span> <span class="n">simulation</span><span class="o">(</span><span class="n">portfolio</span><span class="k">:</span> <span class="kt">Portfolio</span><span class="o">,</span> <span class="n">simulations</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span>
</span><span class="line">    <span class="kt">Channel</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">MarketFactorsGenerator</span>, <span class="kt">Simulations</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * @concurrencyLevel Number of simulation tasks running at the same time</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">MonteCarloMarketRiskCalculator</span><span class="o">(</span><span class="n">simulations</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">,</span>
</span><span class="line">                                              <span class="n">splitFactor</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">10</span><span class="o">,</span>
</span><span class="line">                                              <span class="n">concurrencyLevel</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">  <span class="k">extends</span> <span class="nc">MarketRiskCalculator</span>
</span><span class="line">     <span class="k">with</span> <span class="nc">MarketDataModule</span>
</span><span class="line">     <span class="k">with</span> <span class="nc">MarketFactorsModule</span>
</span><span class="line">     <span class="k">with</span> <span class="nc">PortfolioValueSimulation</span> <span class="o">{</span> <span class="n">calculator</span> <span class="k">=&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">Simulations</span><span class="o">(</span><span class="n">simulations</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>
</span><span class="line">
</span><span class="line">  <span class="k">class</span> <span class="nc">MarketRisk</span><span class="o">(</span><span class="n">initialValue</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">simulations</span><span class="k">:</span> <span class="kt">Simulations</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="nc">VaR</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">...</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">conditionalVaR</span><span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span> <span class="k">val</span> <span class="n">P</span> <span class="k">=</span> <span class="nc">Process</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">marketRisk</span><span class="o">(</span><span class="n">portfolio</span><span class="k">:</span> <span class="kt">Portfolio</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span><span class="k">:</span> <span class="kt">MarketRisk</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Get initial Portfolio value</span>
</span><span class="line">    <span class="k">implicit</span> <span class="k">val</span> <span class="n">initialFactors</span> <span class="k">=</span> <span class="n">marketFactors</span><span class="o">(</span><span class="n">date</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">initialPortfolioValue</span> <span class="k">=</span>
</span><span class="line">      <span class="nc">PortfolioPricer</span><span class="o">.</span><span class="n">price</span><span class="o">(</span><span class="n">portfolio</span><span class="o">).</span>
</span><span class="line">        <span class="n">fold</span><span class="o">(</span><span class="n">err</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Failed price portfolio: $err&quot;</span><span class="o">),</span> <span class="n">identity</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Run portfolio values simulation</span>
</span><span class="line">    <span class="k">val</span> <span class="n">oneSimulation</span> <span class="k">=</span> <span class="n">simulations</span> <span class="o">/</span> <span class="n">splitFactor</span>
</span><span class="line">    <span class="k">val</span> <span class="n">simulationChannel</span> <span class="k">=</span> <span class="n">simulation</span><span class="o">(</span><span class="n">portfolio</span><span class="o">,</span> <span class="n">oneSimulation</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">generator</span> <span class="k">=</span> <span class="n">oneDayMarketFactors</span><span class="o">(</span><span class="n">portfolio</span><span class="o">,</span> <span class="n">date</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">process</span> <span class="k">=</span> <span class="n">P</span><span class="o">.</span>
</span><span class="line">      <span class="n">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">splitFactor</span><span class="o">).</span>
</span><span class="line">      <span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">generator</span><span class="o">).</span>
</span><span class="line">      <span class="n">concurrently</span><span class="o">(</span><span class="n">concurrencyLevel</span><span class="o">)(</span><span class="n">simulationChannel</span><span class="o">).</span>
</span><span class="line">      <span class="n">runFoldMap</span><span class="o">(</span><span class="n">identity</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Produce market-risk object from initial value and simulated values</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">MarketRisk</span><span class="o">(</span><span class="n">initialPortfolioValue</span><span class="o">,</span> <span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="running-simulation-on-a-single-node">Running simulation on a single node</h4>

<p>Here is straightforward PortfolioValueSimulation implementation, that runs simulation tasks in a separate thread pool in a single JVM:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">SingleNodePortfolioValueSimulation</span> <span class="k">extends</span> <span class="nc">PortfolioValueSimulation</span> <span class="o">{</span>
</span><span class="line">  <span class="n">self</span><span class="k">:</span> <span class="kt">MarketFactorsModule</span> <span class="kt">with</span> <span class="kt">MonteCarloMarketRiskCalculator</span> <span class="o">=&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">simulation</span><span class="o">(</span><span class="n">portfolio</span><span class="k">:</span> <span class="kt">Portfolio</span><span class="o">,</span> <span class="n">simulations</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">    <span class="n">channel</span><span class="o">[</span><span class="kt">MarketFactorsGenerator</span>, <span class="kt">Simulations</span><span class="o">]</span> <span class="o">{</span> <span class="n">generator</span> <span class="k">=&gt;</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// calculate portfolio prices for generated market factors</span>
</span><span class="line">      <span class="k">val</span> <span class="n">process</span> <span class="k">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="n">simulations</span><span class="o">).</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">        <span class="k">implicit</span> <span class="n">factors</span> <span class="k">=&gt;</span> <span class="nc">PortfolioPricer</span><span class="o">.</span><span class="n">price</span><span class="o">(</span><span class="n">portfolio</span><span class="o">).</span>
</span><span class="line">          <span class="n">fold</span><span class="o">(</span><span class="n">err</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Failed to price portfolio: $err&quot;</span><span class="o">),</span> <span class="n">identity</span><span class="o">)</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// Fork simulations into thread pool</span>
</span><span class="line">      <span class="nc">Task</span><span class="o">.</span><span class="n">fork</span> <span class="o">{</span>
</span><span class="line">        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Simulate $simulations portfolio values for $portfolio&quot;</span><span class="o">)</span>
</span><span class="line">        <span class="n">process</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span>
</span><span class="line">            <span class="n">map</span><span class="o">(</span><span class="n">portfolioValues</span> <span class="k">=&gt;</span> <span class="nc">Simulations</span><span class="o">(</span><span class="n">portfolioValues</span><span class="o">.</span><span class="n">toVector</span><span class="o">))</span>
</span><span class="line">      <span class="o">}(</span><span class="n">executor</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="run-market-risk-calculation">Run Market Risk Calculation</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">SingleNodeMarketRiskCalculation</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">AMZN</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;AMZN&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">AAPL</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;AAPL&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">IBM</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;IBM&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">GS</span> <span class="k">=</span> <span class="nc">Equity</span><span class="o">(</span><span class="s">&quot;GS&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Portfolio evaluation date</span>
</span><span class="line">  <span class="k">val</span> <span class="n">date</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LocalDate</span><span class="o">(</span><span class="mi">2014</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Options maturity date</span>
</span><span class="line">  <span class="k">val</span> <span class="n">maturityDate</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LocalDate</span><span class="o">(</span><span class="mi">2014</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">31</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">portfolio</span> <span class="k">=</span> <span class="nc">Portfolio</span><span class="o">(</span><span class="n">nels</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Position</span><span class="o">(</span><span class="nc">AMZN</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="nc">Position</span><span class="o">(</span><span class="nc">AAPL</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="nc">Position</span><span class="o">(</span><span class="nc">IBM</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span>
</span><span class="line">    <span class="nc">Position</span><span class="o">(</span><span class="nc">CallOption</span><span class="o">(</span><span class="nc">GS</span><span class="o">,</span> <span class="mi">180</span><span class="o">,</span> <span class="n">maturityDate</span><span class="o">),</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">  <span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="k">object</span> <span class="nc">RiskCalculator</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">MonteCarloMarketRiskCalculator</span><span class="o">(</span><span class="mi">10000</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">    <span class="k">with</span> <span class="nc">SingleNodePortfolioValueSimulation</span>
</span><span class="line">    <span class="k">with</span> <span class="nc">HistoricalMarketFactors</span> <span class="k">with</span> <span class="nc">HistoricalMarketData</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">marketRisk</span> <span class="k">=</span> <span class="nc">RiskCalculator</span><span class="o">.</span><span class="n">marketRisk</span><span class="o">(</span><span class="n">portfolio</span><span class="o">,</span> <span class="n">date</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Calculated marker risk; &quot;</span> <span class="o">+</span>
</span><span class="line">    <span class="n">s</span><span class="s">&quot;VaR(p = 0.95) = ${marketRisk.VaR(0.95)}, &quot;</span> <span class="o">+</span>
</span><span class="line">    <span class="n">s</span><span class="s">&quot;CVaR(p = 0.95) = ${marketRisk.conditionalVaR(0.95)}&quot;</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[simulation-pool-1] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-2] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-0] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-3] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-4] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-5] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-6] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-7] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-8] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">[simulation-pool-9] Simulate 1000 portfolio values for Portfolio( ...
</span><span class="line">
</span><span class="line">Calculated marker risk in 3492 milliseconds:
</span><span class="line">        VaR(p = 0.95) = -135.82237858706867
</span><span class="line">        CVaR(p = 0.95) = -170.1895188516829</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="next-step">Next step</h3>

<p>In next part I’m going to scale-out VaR calculation to multiple nodes, and I will be using latest Akka Cluster for it.</p>

<h2 id="go-to-part-2blog20140501akka-cluster-for-value-at-risk-calculation-2"><a href="http://eugenezhulenev.com/blog/2014/05/01/akka-cluster-for-value-at-risk-calculation-2">»&gt; Go to Part 2</a></h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Seamless Migration From Monolithic Application to Finagle Services (Part 2/2)]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-2/"/>
    <updated>2014-04-09T22:03:45-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-2</id>
    <content type="html"><![CDATA[<h3 id="synopsis">Synopsis</h3>

<blockquote>
  <p>The code &amp; sample app can be found on <a href="https://github.com/ezhulenev/finagled-movie-db">Github</a></p>
</blockquote>

<p>Distributed micro-services architecture is hot trend right now, it’s widely adopted by <a href="https://blog.twitter.com/2011/finagle-a-protocol-agnostic-rpc-system">Twitter</a>, <a href="https://engineering.linkedin.com/architecture/restli-restful-service-architecture-scale">LinkedIn</a> and <a href="http://www.slideshare.net/LappleApple/gilt-from-monolith-ruby-app-to-micro-service-scala-service-architecture">Gilt</a>.
However it can be difficult if data model is already defined, and services accessed via existing API throughout all your code. I’ll show how it’s possible to split monoliths app into standalone services built with Finagle and SBinary for custom communication protocol.</p>

<p>I’m going to show it on example of small Fancy Movie Database application.</p>

<h2 id="part-22-spit-application-to-distributed-services">[Part 2/2] Spit application to distributed services</h2>

<p>Go to <a href="http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-1">Part 1</a> where fancy movie database application defined.</p>

<h3 id="what-is-finagle">What is Finagle</h3>

<p>Finagle is a protocol-agnostic, asynchronous RPC system for the JVM that makes it easy to build robust clients and servers in Java, Scala, or any JVM-hosted language.</p>

<!-- more -->

<h6 id="finagle-provides-a-robust-implementation-of">Finagle provides a robust implementation of:</h6>
<ul>
  <li>connection pools, with throttling to avoid TCP connection churn;</li>
  <li>failure detectors, to identify slow or crashed hosts;</li>
  <li>failover strategies, to direct traffic away from unhealthy hosts;</li>
  <li>load-balancers, including “least-connections” and other strategies; and</li>
</ul>

<p>You can read more about finagle on <a href="http://twitter.github.io/finagle/">official web site</a></p>

<h4 id="whats-wrong-with-finagle">What’s wrong with finagle</h4>

<p>Finagle is protocol agnostic system, and can work independently of underlying protocol, however suggested protocol is Thrift, and tooling support is built around Thrift (code generators, etc).
One biggest drawbacks of Thrift, is that it’s required to define model and services using interface definition language (IDL).
However if model and services already defined (as in this example), it can be painful to migrate well-typed scala model to IDL.</p>

<p>In this case we can use protocol-agnostic property of Finagle and write out own binary protocol for existing scala model.</p>

<h3 id="sbinary">SBinary</h3>

<p><a href="https://github.com/harrah/sbinary">SBinary</a> is a library for describing binary protocols, in the form of mappings between Scala types and binary formats. It can be used as a robust serialization mechanism for Scala objects or a way of dealing with existing binary formats found in the wild.</p>

<blockquote>
  <p>Great <a href="https://code.google.com/p/sbinary/wiki/IntroductionToSBinary">Introduction to SBinary</a> article</p>
</blockquote>

<h3 id="binary-format-for-data-model">Binary format for data model</h3>

<p>First we need a way to read/write data model from binary representation:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">ModelProtocol</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">sbinary.DefaultProtocol._</span>
</span><span class="line">  <span class="k">import</span> <span class="nn">sbinary.Operations._</span>
</span><span class="line">  <span class="k">import</span> <span class="nn">sbinary._</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">genreFormat</span> <span class="k">extends</span> <span class="nc">Format</span><span class="o">[</span><span class="kt">Genre</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">import</span> <span class="nn">Genre._</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Input</span><span class="o">)</span><span class="k">:</span> <span class="kt">Genre</span> <span class="o">=</span> <span class="n">read</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="n">in</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="mi">0</span> <span class="k">=&gt;</span> <span class="nc">Action</span>
</span><span class="line">      <span class="k">case</span> <span class="mi">1</span> <span class="k">=&gt;</span> <span class="nc">Adventure</span>
</span><span class="line">      <span class="o">....</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">out</span><span class="k">:</span> <span class="kt">Output</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Genre</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">genreCode</span><span class="k">:</span> <span class="kt">Byte</span> <span class="o">=</span> <span class="n">value</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">Action</span>      <span class="k">=&gt;</span> <span class="mi">0</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">Adventure</span>   <span class="k">=&gt;</span> <span class="mi">1</span>
</span><span class="line">        <span class="o">....</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">write</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="n">out</span><span class="o">,</span> <span class="n">genreCode</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">personFormat</span> <span class="k">extends</span> <span class="nc">Format</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Input</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">      <span class="nc">Person</span><span class="o">(</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">in</span><span class="o">),</span> <span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">in</span><span class="o">),</span> <span class="n">read</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">](</span><span class="n">in</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">out</span><span class="k">:</span> <span class="kt">Output</span><span class="o">,</span> <span class="n">person</span><span class="k">:</span> <span class="kt">Person</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">out</span><span class="o">,</span> <span class="n">person</span><span class="o">.</span><span class="n">firstName</span><span class="o">)</span>
</span><span class="line">      <span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">out</span><span class="o">,</span> <span class="n">person</span><span class="o">.</span><span class="n">secondName</span><span class="o">)</span>
</span><span class="line">      <span class="n">write</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">](</span><span class="n">out</span><span class="o">,</span> <span class="n">person</span><span class="o">.</span><span class="n">born</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">   <span class="c1">// ... much more on Github</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="binary-format-for-requestresponse">Binary format for Request/Response</h3>

<p>Nest step, is to build request-response commands that going to be passed between server and client:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">ServiceProtocol</span> <span class="k">extends</span> <span class="nc">ModelProtocol</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">FmdbReq</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">GetPeople</span> <span class="k">extends</span> <span class="nc">FmdbReq</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">GetMovies</span><span class="o">(</span><span class="n">year</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">genre</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Genre</span><span class="o">],</span> <span class="n">person</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Person</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">FmdbReq</span>
</span><span class="line">
</span><span class="line">  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">FmdbRep</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">GotPeople</span><span class="o">(</span><span class="n">people</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Person</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">FmdbRep</span>
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">GotMovies</span><span class="o">(</span><span class="n">movies</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Movie</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">FmdbRep</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">requestFormat</span> <span class="k">extends</span> <span class="nc">Format</span><span class="o">[</span><span class="kt">FmdbReq</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Input</span><span class="o">)</span> <span class="k">=</span> <span class="n">read</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="n">in</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="mi">0</span> <span class="k">=&gt;</span>
</span><span class="line">           <span class="nc">GetPeople</span>
</span><span class="line">
</span><span class="line">      <span class="k">case</span> <span class="mi">1</span> <span class="k">=&gt;</span>
</span><span class="line">           <span class="nc">GetMovies</span><span class="o">(</span><span class="n">read</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="n">in</span><span class="o">),</span>
</span><span class="line">                     <span class="n">read</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Genre</span><span class="o">]](</span><span class="n">in</span><span class="o">),</span>
</span><span class="line">                     <span class="n">read</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Person</span><span class="o">]](</span><span class="n">in</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">out</span><span class="k">:</span> <span class="kt">Output</span><span class="o">,</span> <span class="n">req</span><span class="k">:</span> <span class="kt">FmdbReq</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">req</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">GetPeople</span> <span class="k">=&gt;</span>
</span><span class="line">          <span class="n">write</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="n">out</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">case</span> <span class="nc">GetMovies</span><span class="o">(</span><span class="n">year</span><span class="o">,</span> <span class="n">genre</span><span class="o">,</span> <span class="n">person</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class="line">           <span class="n">write</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="n">out</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
</span><span class="line">           <span class="n">write</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="n">out</span><span class="o">,</span> <span class="n">year</span><span class="o">)</span>
</span><span class="line">           <span class="n">write</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Genre</span><span class="o">]](</span><span class="n">out</span><span class="o">,</span> <span class="n">genre</span><span class="o">)</span>
</span><span class="line">           <span class="n">write</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Person</span><span class="o">]](</span><span class="n">out</span><span class="o">,</span> <span class="n">person</span><span class="o">)</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ... the same for Response, see more on Github</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="combine-it-all-together">Combine it all together</h3>

<p>Now we need to combine together binary protocol defined earlier with Finagle channel pipelines, and create Client/Server builders.</p>

<p>For sure we want to update this binary protocol at some later point, adding new commands and updating application model, and to be it still safe.
For this reason I’m wrapping each message into <code>versioned envelop</code>, however I’m not going to describe it in this post, full code is available on Github.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">Fmdb</span> <span class="o">{</span>
</span><span class="line">  <span class="k">import</span> <span class="nn">ServiceProtocol._</span>
</span><span class="line">  <span class="k">import</span> <span class="nn">envelopeCodec._</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="nc">ProtocolVersion</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">1</span><span class="n">l</span>
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="nc">ReqDecoder</span> <span class="k">=</span>
</span><span class="line">     <span class="n">versionCheckingEnvelopeToContentDecoder</span><span class="o">[</span><span class="kt">FmdbReq</span><span class="o">](</span><span class="nc">ProtocolVersion</span><span class="o">)</span>
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="nc">RepDecoder</span> <span class="k">=</span>
</span><span class="line">     <span class="n">versionCheckingEnvelopeToContentDecoder</span><span class="o">[</span><span class="kt">FmdbRep</span><span class="o">](</span><span class="nc">ProtocolVersion</span><span class="o">)</span>
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="nc">ReqEncoder</span> <span class="k">=</span> <span class="n">typeSafeEncoder</span><span class="o">[</span><span class="kt">FmdbReq</span><span class="o">]</span>
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="nc">RepEncoder</span> <span class="k">=</span> <span class="n">typeSafeEncoder</span><span class="o">[</span><span class="kt">FmdbRep</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">object</span> <span class="nc">FmdbServerPipeline</span> <span class="k">extends</span> <span class="nc">ChannelPipelineFactory</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">getPipeline</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">pipeline</span> <span class="k">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="n">pipeline</span><span class="o">()</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;envDecoder&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">EnvelopeDecoder</span><span class="o">)</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;reqDecoder&quot;</span><span class="o">,</span> <span class="nc">ReqDecoder</span><span class="o">)</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;envEncoder&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">EnvelopeEncoder</span><span class="o">(</span><span class="nc">ProtocolVersion</span><span class="o">))</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;repEncoder&quot;</span><span class="o">,</span> <span class="nc">RepEncoder</span><span class="o">)</span>
</span><span class="line">      <span class="n">pipeline</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">object</span> <span class="nc">FmdbClientPipeline</span> <span class="k">extends</span> <span class="nc">ChannelPipelineFactory</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">getPipeline</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">pipeline</span> <span class="k">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="n">pipeline</span><span class="o">()</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;envEncode&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">EnvelopeEncoder</span><span class="o">(</span><span class="nc">ProtocolVersion</span><span class="o">))</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;reqEncode&quot;</span><span class="o">,</span> <span class="nc">ReqEncoder</span><span class="o">)</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;envDecode&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">EnvelopeDecoder</span><span class="o">)</span>
</span><span class="line">      <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;repDecode&quot;</span><span class="o">,</span> <span class="nc">RepDecoder</span><span class="o">)</span>
</span><span class="line">      <span class="n">pipeline</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">object</span> <span class="nc">FmdbClientTransporter</span> <span class="k">extends</span> <span class="nc">Netty3Transporter</span><span class="o">[</span><span class="kt">FmdbReq</span>, <span class="kt">FmdbRep</span><span class="o">](</span>
</span><span class="line">    <span class="s">&quot;fmdbClientTransporter&quot;</span><span class="o">,</span> <span class="nc">FmdbClientPipeline</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">distributed</span><span class="o">]</span> <span class="k">object</span> <span class="nc">Client</span> <span class="k">extends</span> <span class="nc">DefaultClient</span><span class="o">[</span><span class="kt">FmdbReq</span>, <span class="kt">FmdbRep</span><span class="o">](</span>
</span><span class="line">    <span class="s">&quot;fmdbClient&quot;</span><span class="o">,</span> <span class="n">endpointer</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">bridge</span> <span class="k">=</span>
</span><span class="line">        <span class="nc">Bridge</span><span class="o">[</span><span class="kt">FmdbReq</span>, <span class="kt">FmdbRep</span>, <span class="kt">FmdbReq</span>, <span class="kt">FmdbRep</span><span class="o">](</span><span class="nc">FmdbClientTransporter</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SerialClientDispatcher</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">      <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">stats</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">bridge</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">stats</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">object</span> <span class="nc">FmdbListener</span> <span class="k">extends</span> <span class="nc">Netty3Listener</span><span class="o">[</span><span class="kt">FmdbRep</span>, <span class="kt">FmdbReq</span><span class="o">](</span>
</span><span class="line">    <span class="s">&quot;fmdbListener&quot;</span><span class="o">,</span> <span class="nc">FmdbServerPipeline</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span><span class="o">[</span><span class="kt">distributed</span><span class="o">]</span> <span class="k">object</span> <span class="nc">Server</span> <span class="k">extends</span> <span class="nc">DefaultServer</span><span class="o">[</span><span class="kt">FmdbReq</span>, <span class="kt">FmdbRep</span>, <span class="kt">FmdbRep</span>, <span class="kt">FmdbReq</span><span class="o">](</span>
</span><span class="line">    <span class="s">&quot;fmdbServer&quot;</span><span class="o">,</span> <span class="nc">FmdbListener</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SerialServerDispatcher</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="services-implementation">Services implementation</h3>

<p>Now we can implement services defined in first part, that will perform network call to Finagle server, instead of running computations/data-fetching locally:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">FmdbServerConfig</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">serverAddress</span><span class="k">:</span> <span class="kt">SocketAddress</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">ServiceProtocol._</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="n">retry</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RetryingFilter</span><span class="o">[</span><span class="kt">FmdbReq</span>, <span class="kt">FmdbRep</span><span class="o">](</span>
</span><span class="line">    <span class="n">retryPolicy</span> <span class="k">=</span> <span class="nc">RetryPolicy</span><span class="o">.</span><span class="n">tries</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
</span><span class="line">    <span class="n">timer</span> <span class="k">=</span> <span class="nc">DefaultTimer</span><span class="o">.</span><span class="n">twitter</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TimeoutFilter</span><span class="o">[</span><span class="kt">FmdbReq</span>, <span class="kt">FmdbRep</span><span class="o">](</span>
</span><span class="line">    <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">fromSeconds</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span>
</span><span class="line">    <span class="n">timer</span> <span class="k">=</span> <span class="nc">DefaultTimer</span><span class="o">.</span><span class="n">twitter</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">lazy</span> <span class="k">val</span> <span class="n">client</span> <span class="k">=</span>
</span><span class="line">    <span class="n">retry</span>      <span class="n">andThen</span>
</span><span class="line">    <span class="n">timeout</span>    <span class="n">andThen</span>
</span><span class="line">    <span class="nc">Fmdb</span><span class="o">.</span><span class="nc">Client</span><span class="o">.</span><span class="n">newService</span><span class="o">(</span><span class="nc">Name</span><span class="o">.</span><span class="n">bound</span><span class="o">(</span><span class="n">serverAddress</span><span class="o">),</span> <span class="s">&quot;fmdbClient&quot;</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">PeopleServiceImpl</span> <span class="k">extends</span> <span class="nc">PeopleService</span> <span class="k">with</span> <span class="nc">FmdbServerConfig</span> <span class="o">{</span>
</span><span class="line">  <span class="k">import</span> <span class="nn">ServiceProtocol._</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">people</span><span class="o">()</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">Person</span><span class="o">]]</span> <span class="k">=</span> <span class="n">client</span><span class="o">(</span><span class="nc">GetPeople</span><span class="o">).</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="nc">GotPeople</span><span class="o">(</span><span class="n">people</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">people</span>
</span><span class="line">    <span class="k">case</span> <span class="n">err</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Unexpected server response: $err&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}.</span><span class="n">toScala</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">// ... more on Github</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I’m not going to describe hot convert Twitter Future to Scala Future, it’s all available on <a href="https://github.com/ezhulenev/finagled-movie-db">Github</a>.</p>

<h3 id="lets-run-it">Let’s run it!</h3>

<p>Let’s find all movies with Leonardo DiCaprio, as we did in first part. However now example application will be a client that will be sending requests via network to movies service server.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">DistributedExample</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">address</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">10000</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Lets start server</span>
</span><span class="line">  <span class="k">val</span> <span class="n">server</span> <span class="k">=</span> <span class="nc">FmdbServer</span><span class="o">.</span><span class="n">serve</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Lets create services</span>
</span><span class="line">  <span class="k">object</span> <span class="nc">Services</span> <span class="k">extends</span> <span class="nc">PeopleServiceImpl</span> <span class="k">with</span> <span class="nc">MoviesServiceImpl</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">serverAddress</span><span class="k">:</span> <span class="kt">SocketAddress</span> <span class="o">=</span> <span class="n">address</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Lets&#39; get all movies for Leonardo DiCaprio</span>
</span><span class="line">  <span class="k">val</span> <span class="n">leo</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span>
</span><span class="line">    <span class="n">result</span><span class="o">(</span><span class="nc">Services</span><span class="o">.</span><span class="n">people</span><span class="o">(),</span> <span class="mf">1.</span><span class="n">second</span><span class="o">).</span><span class="n">find</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">firstName</span> <span class="o">==</span> <span class="s">&quot;Leonardo&quot;</span><span class="o">).</span><span class="n">get</span>
</span><span class="line">  <span class="k">val</span> <span class="n">leoMovies</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span>
</span><span class="line">    <span class="n">result</span><span class="o">(</span><span class="nc">Services</span><span class="o">.</span><span class="n">movies</span><span class="o">(</span><span class="n">leo</span><span class="o">),</span> <span class="mf">1.</span><span class="n">second</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Movies with ${leo.firstName} ${leo.secondName}:&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="n">leoMovies</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot; - ${m.title}, ${m.year}&quot;</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Shutdown</span>
</span><span class="line">  <span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">  <span class="nc">System</span><span class="o">.</span><span class="n">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h5 id="output">Output</h5>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">Apr 09, 2014 2:02:18 PM com.twitter.finagle.Init$ apply
</span><span class="line">INFO: Finagle version 6.13.1 (rev=12bb3f3f5004109a4c2b981091a327b6ba2e7a6a) built at 20140324-225705
</span><span class="line">Movies with Leonardo DiCaprio:
</span><span class="line"> - Django Unchained, 2012</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="result">Result</h3>

<p>As you can see final application in Part 1 is pretty the same is in Part 2.
But with Finagle server-side part of application can be scaled independently, and completely transparent to the client.</p>

<p>Finagle has amazing cluster discovery support, built on top of Zookeeper and ServerGroups, and it’s perfect choice for cloud environment.</p>

<h2 id="go-to-part-1blog20140409seamless-migration-from-monolithic-application-to-finagle-services-1"><a href="http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-1">«&lt; Go to Part 1</a></h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Seamless Migration From Monolithic Application to Finagle Services (Part 1/2)]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-1/"/>
    <updated>2014-04-09T22:03:45-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-1</id>
    <content type="html"><![CDATA[<h3 id="synopsis">Synopsis</h3>

<blockquote>
  <p>The code &amp; sample app can be found on <a href="https://github.com/ezhulenev/finagled-movie-db">Github</a></p>
</blockquote>

<p>Distributed micro-services architecture is hot trend right now, it’s widely adopted by <a href="https://blog.twitter.com/2011/finagle-a-protocol-agnostic-rpc-system">Twitter</a>, <a href="https://engineering.linkedin.com/architecture/restli-restful-service-architecture-scale">LinkedIn</a> and <a href="http://www.slideshare.net/LappleApple/gilt-from-monolith-ruby-app-to-micro-service-scala-service-architecture">Gilt</a>.
However it can be difficult if data model is already defined, and services accessed via existing API throughout all your code. I’ll show how it’s possible to split monoliths app into standalone services built with Finagle and SBinary for custom communication protocol.</p>

<p>I’m going to show it on example of small Fancy Movie Database application.</p>

<h2 id="part-1-fancy-movie-database-application">[Part 1] Fancy Movie Database application</h2>

<p>Go to <a href="http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-2">Part 2</a> where fancy movie database application is divided into server and client using Finagle.</p>

<!-- more -->

<h3 id="data-model">Data model</h3>

<p>Let’s start with application data model definition:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Genre</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Genre</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Action</span>      <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Adventure</span>   <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Animation</span>   <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Biography</span>   <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Comedy</span>      <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Crime</span>       <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Documentary</span> <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Drama</span>       <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Thriller</span>    <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">Western</span>     <span class="k">extends</span> <span class="nc">Genre</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">firstName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">secondName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">born</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">Cast</span><span class="o">(</span><span class="n">person</span><span class="k">:</span> <span class="kt">Person</span><span class="o">,</span> <span class="n">as</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">Movie</span><span class="o">(</span><span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">                 <span class="n">genre</span><span class="k">:</span> <span class="kt">Genre</span><span class="o">,</span>
</span><span class="line">                 <span class="n">year</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
</span><span class="line">                 <span class="n">directedBy</span><span class="k">:</span> <span class="kt">Person</span><span class="o">,</span>
</span><span class="line">                 <span class="n">cast</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">Cast</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="services-definition">Services definition</h3>

<p>And services that we want to provide:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">PeopleService</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">people</span><span class="o">()</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">Person</span><span class="o">]]</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">MoviesService</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">movies</span><span class="o">()</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]]</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">movies</span><span class="o">(</span><span class="n">year</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]]</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">movies</span><span class="o">(</span><span class="n">genre</span><span class="k">:</span> <span class="kt">Genre</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]]</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">movies</span><span class="o">(</span><span class="n">person</span><span class="k">:</span> <span class="kt">Person</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]]</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="mock-data-access-layer">Mock data access layer</h3>

<p>In real application we probably would have SQL database or some other type of storage with movies data.
Let’s assume that this storage is <code>blocking resource</code>, and quite expensive to access.
However for this example application I will use small in-memory mock implementation of access layer with only two movies directed by <a href="http://www.imdb.com/name/nm0000233/">Quentin Tarantino</a>: <a href="http://www.imdb.com/title/tt1853728/?ref_=nm_flmg_dr_3">Django Unchained</a>, and <a href="http://www.imdb.com/title/tt0361748/?ref_=nm_flmg_dr_4">Inglourious Basterds</a></p>

<blockquote>
  <p>Source code for access layer on Github: <a href="https://github.com/ezhulenev/finagled-movie-db/blob/master/core/src/main/scala/com/fmdb/MovieDatabaseAccess.scala">MovieDatabaseAccess.scala</a></p>
</blockquote>

<h3 id="lets-be-reactive">Let’s be reactive</h3>

<p>I hope we all agree that applications needs to be <code>reactive</code>, that’s why I’m wrapping <code>blocking</code> calls into <code>scala.concurrent.future</code>.</p>

<p>Straightforward services layer implementation:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">package</span> <span class="nn">object</span> <span class="n">monolithic</span> <span class="o">{</span>
</span><span class="line"><span class="k">trait</span> <span class="nc">PeopleServiceImpl</span> <span class="k">extends</span> <span class="nc">PeopleService</span> <span class="o">{</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">people</span><span class="o">()</span> <span class="k">=</span>
</span><span class="line">       <span class="n">future</span> <span class="o">{</span> <span class="nc">MovieDatabaseAccess</span><span class="o">.</span><span class="n">people</span><span class="o">()</span> <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">MoviesServiceImpl</span> <span class="k">extends</span> <span class="nc">MoviesService</span> <span class="o">{</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">movies</span><span class="o">(</span><span class="n">person</span><span class="k">:</span> <span class="kt">Person</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">       <span class="n">future</span> <span class="o">{</span> <span class="nc">MovieDatabaseAccess</span><span class="o">.</span><span class="n">movies</span><span class="o">(</span><span class="n">person</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">movies</span><span class="o">(</span><span class="n">genre</span><span class="k">:</span> <span class="kt">Genre</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">       <span class="n">future</span> <span class="o">{</span> <span class="nc">MovieDatabaseAccess</span><span class="o">.</span><span class="n">movies</span><span class="o">(</span><span class="n">genre</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">movies</span><span class="o">(</span><span class="n">year</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">       <span class="n">future</span> <span class="o">{</span> <span class="nc">MovieDatabaseAccess</span><span class="o">.</span><span class="n">movies</span><span class="o">(</span><span class="n">year</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">movies</span><span class="o">()</span> <span class="k">=</span>
</span><span class="line">       <span class="n">future</span> <span class="o">{</span> <span class="nc">MovieDatabaseAccess</span><span class="o">.</span><span class="n">movies</span><span class="o">()</span> <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="lets-combine-it-together">Let’s combine it together</h3>

<p>After model and services are defined, and basic implementation is provided we can build simple application for querying Fancy Movies Database.</p>

<p>Let’s find all movies with Leonardo DiCaprio:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">MonolithicExample</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Lets create services</span>
</span><span class="line">  <span class="k">object</span> <span class="nc">Services</span> <span class="k">extends</span> <span class="nc">PeopleServiceImpl</span> <span class="k">with</span> <span class="nc">MoviesServiceImpl</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Lets&#39; get all movies for Leonardo DiCaprio</span>
</span><span class="line">  <span class="k">val</span> <span class="n">leo</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span>
</span><span class="line">    <span class="n">result</span><span class="o">(</span><span class="nc">Services</span><span class="o">.</span><span class="n">people</span><span class="o">(),</span> <span class="mf">1.</span><span class="n">second</span><span class="o">).</span><span class="n">find</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">firstName</span> <span class="o">==</span> <span class="s">&quot;Leonardo&quot;</span><span class="o">).</span><span class="n">get</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">leoMovies</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span>
</span><span class="line">    <span class="n">result</span><span class="o">(</span><span class="nc">Services</span><span class="o">.</span><span class="n">movies</span><span class="o">(</span><span class="n">leo</span><span class="o">),</span> <span class="mf">1.</span><span class="n">second</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Movies with ${leo.firstName} ${leo.secondName}:&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="n">leoMovies</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot; - ${m.title}, ${m.year}&quot;</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Shutdown</span>
</span><span class="line">  <span class="nc">System</span><span class="o">.</span><span class="n">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h5 id="output">Output</h5>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">Movies with Leonardo DiCaprio:
</span><span class="line"> - Django Unchained, 2012</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="next-step">Next step</h3>

<p>In next part I’m going to divide this application into server and client preserving existing API, such that migration from monolithic application to distributed is completely seamless for <code>service clients</code>.</p>

<h2 id="go-to-part-2blog20140409seamless-migration-from-monolithic-application-to-finagle-services-2"><a href="http://eugenezhulenev.com/blog/2014/04/09/seamless-migration-from-monolithic-application-to-finagle-services-2">»&gt; Go to Part 2</a></h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Scalaz-Stream: Feed `Process` Through the Given Effectful `Channel` Concurrently]]></title>
    <link href="http://eugenezhulenev.com/blog/2014/04/01/scalaz-stream-concurrent-process/"/>
    <updated>2014-04-01T22:03:03-04:00</updated>
    <id>http://eugenezhulenev.com/blog/2014/04/01/scalaz-stream-concurrent-process</id>
    <content type="html"><![CDATA[<p>Let’s assume that we have some input process, and want to run some ‘heavy computation’ on each element.
Obviously we want utilize all available cores and use thread pool. However scalaz-stream by default is deterministic
and in following example all computation steps will run consecutively.</p>

<!-- more -->

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line">  <span class="k">val</span> <span class="n">timeFormat</span> <span class="k">=</span> <span class="nc">DateTimeFormat</span><span class="o">.</span><span class="n">forPattern</span><span class="o">(</span><span class="s">&quot;HH:mm:ss:SSS&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">counter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// ThreadPool for running effectful functions</span>
</span><span class="line">  <span class="k">val</span> <span class="n">executor</span> <span class="k">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="n">newFixedThreadPool</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// channel of effectful functions</span>
</span><span class="line">  <span class="k">val</span> <span class="n">effectfulChannel</span> <span class="k">=</span> <span class="n">channel</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="n">in</span> <span class="k">=&gt;</span> <span class="nc">Task</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">taskN</span> <span class="k">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">incrementAndGet</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">      <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;${Thread.currentThread().getName}: &quot;</span> <span class="o">+</span>
</span><span class="line">        <span class="n">s</span><span class="s">&quot;Run for $in, &quot;</span> <span class="o">+</span>
</span><span class="line">        <span class="n">s</span><span class="s">&quot;TaskN = $taskN &quot;</span> <span class="o">+</span>
</span><span class="line">        <span class="n">s</span><span class="s">&quot;(time = ${timeFormat.print(System.currentTimeMillis())})&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// Long running computation</span>
</span><span class="line">      <span class="k">val</span> <span class="n">computed</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class="line">        <span class="n">in</span> <span class="o">*</span> <span class="n">in</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">computed</span>
</span><span class="line">    <span class="o">}(</span><span class="n">executor</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">start</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()</span>
</span><span class="line">  <span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">11</span><span class="o">).</span><span class="n">through</span><span class="o">(</span><span class="n">effectfulChannel</span><span class="o">).</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span><span class="line">  <span class="k">val</span> <span class="n">end</span> <span class="k">=</span> <span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()</span>
</span><span class="line">  <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Output = $output, in ${end-start} ms&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="deterministic-output">Deterministic Output</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class=""><span class="line">pool-1-thread-1: Run for 1, TaskN = 1   (time = 22:59:14:720)
</span><span class="line">pool-1-thread-2: Run for 2, TaskN = 2   (time = 22:59:15:811)
</span><span class="line">pool-1-thread-3: Run for 3, TaskN = 3   (time = 22:59:16:813)
</span><span class="line">pool-1-thread-3: Run for 4, TaskN = 4   (time = 22:59:17:815)
</span><span class="line">pool-1-thread-3: Run for 5, TaskN = 5   (time = 22:59:18:817)
</span><span class="line">pool-1-thread-3: Run for 6, TaskN = 6   (time = 22:59:19:818)
</span><span class="line">pool-1-thread-3: Run for 7, TaskN = 7   (time = 22:59:20:819)
</span><span class="line">pool-1-thread-3: Run for 8, TaskN = 8   (time = 22:59:21:821)
</span><span class="line">pool-1-thread-3: Run for 9, TaskN = 9   (time = 22:59:22:822)
</span><span class="line">pool-1-thread-3: Run for 10, TaskN = 10 (time = 22:59:23:823)
</span><span class="line">Output = Vector(1, 4, 9, 16, 25, 36, 49, 64, 81, 100), in 10196 ms</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="concurrent-process">Concurrent Process</h3>

<p>To run effectful functions concurrently, with controlled number of queued tasks we can use <code>scalaz.stream.merge.mergeN</code> which is for now available only in <code>snapshot-0.4</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line">  <span class="k">val</span> <span class="n">P</span> <span class="k">=</span> <span class="n">scalaz</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="nc">Process</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">ConcurrentProcess</span><span class="o">[</span><span class="kt">O</span><span class="o">](</span><span class="k">val</span> <span class="n">process</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">O</span><span class="o">])</span> <span class="o">{</span>
</span><span class="line">    <span class="cm">/**</span>
</span><span class="line"><span class="cm">     * Run process through channel with given level of concurrency</span>
</span><span class="line"><span class="cm">     */</span>
</span><span class="line">    <span class="k">def</span> <span class="n">concurrently</span><span class="o">[</span><span class="kt">O2</span><span class="o">](</span><span class="n">concurrencyLevel</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class="line">                        <span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Channel</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">O</span>, <span class="kt">O2</span><span class="o">])</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">O2</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">actions</span> <span class="k">=</span>
</span><span class="line">        <span class="n">process</span><span class="o">.</span>
</span><span class="line">          <span class="n">zipWith</span><span class="o">(</span><span class="n">f</span><span class="o">)((</span><span class="n">data</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">data</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">      <span class="k">val</span> <span class="n">nestedActions</span> <span class="k">=</span>
</span><span class="line">        <span class="n">actions</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">P</span><span class="o">.</span><span class="n">eval</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="n">merge</span><span class="o">.</span><span class="n">mergeN</span><span class="o">(</span><span class="n">concurrencyLevel</span><span class="o">)(</span><span class="n">nestedActions</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line">  <span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">11</span><span class="o">)</span>
</span><span class="line">               <span class="o">.</span><span class="n">concurrently</span><span class="o">(</span><span class="mi">5</span><span class="o">)(</span><span class="n">effectfulChannel</span><span class="o">).</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="concurrent-process-output">Concurrent Process Output</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class=""><span class="line">pool-1-thread-1: Run for 1, TaskN = 1 (time = 12:00:15:625)
</span><span class="line">pool-1-thread-3: Run for 3, TaskN = 3 (time = 12:00:15:626)
</span><span class="line">pool-1-thread-2: Run for 2, TaskN = 2 (time = 12:00:15:626)
</span><span class="line">pool-1-thread-3: Run for 4, TaskN = 4 (time = 12:00:16:683)
</span><span class="line">pool-1-thread-1: Run for 5, TaskN = 5 (time = 12:00:16:683)
</span><span class="line">pool-1-thread-2: Run for 6, TaskN = 6 (time = 12:00:16:693)
</span><span class="line">pool-1-thread-3: Run for 7, TaskN = 7 (time = 12:00:17:684)
</span><span class="line">pool-1-thread-1: Run for 8, TaskN = 8 (time = 12:00:17:684)
</span><span class="line">pool-1-thread-2: Run for 9, TaskN = 9 (time = 12:00:17:694)
</span><span class="line">pool-1-thread-3: Run for 10, TaskN = 10 (time = 12:00:18:685)
</span><span class="line">Output = Vector(4, 9, 1, 25, 16, 36, 49, 64, 81, 100), in 4234 ms</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="result">Result</h3>

<p>As you can see in second case computations run concurrently and total time spent is much smaller, and final result is the same, as expected.</p>

<p>Full code for this post is available in <a href="https://gist.github.com/ezhulenev/9916972">Gist</a>.</p>
]]></content>
  </entry>
  
</feed>
